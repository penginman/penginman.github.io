<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>KKapi+ISpeak说说页面部署 - Braindance</title><meta name=Description content="Braindance's blog"><meta property="og:title" content="KKapi+ISpeak说说页面部署"><meta property="og:description" content="前言感觉原来的 Artitalk 说说不好康，在开往里发现好多博客都用的说说功能叫叨叨点啥，看了看作者的说说页面，可以插入图片和标签分类，还有仅自己可见的功能"><meta property="og:type" content="article"><meta property="og:url" content="https://www.braindance.top/posts/kkapi+ispeak%E8%AF%B4%E8%AF%B4%E9%A1%B5%E9%9D%A2%E9%83%A8%E7%BD%B2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-04T00:00:00+08:00"><meta property="article:modified_time" content="2022-10-16T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="KKapi+ISpeak说说页面部署"><meta name=twitter:description content="前言感觉原来的 Artitalk 说说不好康，在开往里发现好多博客都用的说说功能叫叨叨点啥，看了看作者的说说页面，可以插入图片和标签分类，还有仅自己可见的功能"><meta name=application-name content="Braindance"><meta name=apple-mobile-web-app-title content="Braindance"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://www.braindance.top/posts/kkapi+ispeak%E8%AF%B4%E8%AF%B4%E9%A1%B5%E9%9D%A2%E9%83%A8%E7%BD%B2/><link rel=prev href=https://www.braindance.top/posts/%E8%BF%91%E6%9C%9F%E6%80%BB%E7%BB%93/><link rel=next href=https://www.braindance.top/posts/zut-%E4%BD%BF%E7%94%A8%E8%B7%AF%E7%94%B1%E5%99%A8%E8%BF%9E%E6%8E%A5%E6%A0%A1%E5%9B%AD%E7%BD%91/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"KKapi+ISpeak说说页面部署","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.braindance.top\/posts\/kkapi\u002bispeak%E8%AF%B4%E8%AF%B4%E9%A1%B5%E9%9D%A2%E9%83%A8%E7%BD%B2\/"},"genre":"posts","keywords":"说说","wordcount":2306,"url":"https:\/\/www.braindance.top\/posts\/kkapi\u002bispeak%E8%AF%B4%E8%AF%B4%E9%A1%B5%E9%9D%A2%E9%83%A8%E7%BD%B2\/","datePublished":"2022-10-04T00:00:00+08:00","dateModified":"2022-10-16T00:00:00+08:00","publisher":{"@type":"Organization","name":"Braindance"},"author":{"@type":"Person","name":"Braindance"},"description":""}</script><script src=//instant.page/5.1.1 defer type=module integrity=sha384-MWfCL6g1OTGsbSwfuMHc8+8J2u71/LA8dzlIN3ycajckxuZZmF+DNjdm7O6H3PSq></script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else""==="light"||""==="dark"||""==="black"?(setTheme(""),saveTheme("")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")]</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Braindance>Braindance</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title=文章>文章 </a><a class=menu-item href=/tags/ title=标签>标签 </a><a class=menu-item href=/categories/ title=分类>分类 </a><a class=menu-item href=/about/ title=关于>关于 </a><a class=menu-item href=/friend/ title=友链>友链 </a><a class=menu-item href=https://travellings.cn title=开往 rel="noopener noreferrer" target=_blank>🚇 开往 </a><a class=menu-item href=https://notion.braindance.top title=同步notion笔记 rel="noopener noreferrer" target=_blank><img class=emoji src=https://www.penginman.com/img/favicon.ico width=20> 笔记 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜些什么 id=search-input-desktop>
<a href=# class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=# class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=# class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Braindance>Braindance</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜些什么 id=search-input-mobile>
<a href=# class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=# class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=# class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title=文章>文章</a><a class=menu-item href=/tags/ title=标签>标签</a><a class=menu-item href=/categories/ title=分类>分类</a><a class=menu-item href=/about/ title=关于>关于</a><a class=menu-item href=/friend/ title=友链>友链</a><a class=menu-item href=https://travellings.cn title=开往 rel="noopener noreferrer" target=_blank>🚇开往</a><a class=menu-item href=https://notion.braindance.top title=同步notion笔记 rel="noopener noreferrer" target=_blank><img class=emoji src=https://www.penginman.com/img/favicon.ico width=20>笔记</a><a href=# class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#项目结构>项目结构</a></li><li><a href=#后端部署>后端部署</a><ul><li><a href=#docker-安装-mongodb>Docker 安装 Mongodb</a></li><li><a href=#kkapi-部署>kkapi 部署</a></li><li><a href=#kkapiadmin可视化管理后台>kkapiadmin（可视化管理后台）</a></li></ul></li><li><a href=#前端部署>前端部署</a></li><li><a href=#github-登陆验证可选>Github 登陆验证（可选*）</a></li><li><a href=#完工>完工</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle","normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">KKapi+ISpeak说说页面部署</h1><div class=post-meta><div class=post-meta-line><span class=post-author><i class="author fas fa-user-circle fa-fw"></i><a href=/ title=Author rel=author class=author>Braindance</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/%E7%9E%8E%E6%8A%98%E8%85%BE/><i class="far fa-folder fa-fw"></i>瞎折腾</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-10-04>2022-10-04</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2022-10-16>2022-10-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2306 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 5 分钟&nbsp;<span id=/posts/kkapi+ispeak%E8%AF%B4%E8%AF%B4%E9%A1%B5%E9%9D%A2%E9%83%A8%E7%BD%B2/ class=leancloud_visitors data-flag-title=KKapi+ISpeak说说页面部署>
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count id=twikoo_visitors></span>&nbsp;次阅读
</span>&nbsp;<span id=/posts/kkapi+ispeak%E8%AF%B4%E8%AF%B4%E9%A1%B5%E9%9D%A2%E9%83%A8%E7%BD%B2/ class=comment_count data-flag-title=KKapi+ISpeak说说页面部署>
<i class="far fa-comments fa-fw"></i>&nbsp;<span class=twikoo-comment-count id=twikoo-comment-count></span>&nbsp;条评论
</span>&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#项目结构>项目结构</a></li><li><a href=#后端部署>后端部署</a><ul><li><a href=#docker-安装-mongodb>Docker 安装 Mongodb</a></li><li><a href=#kkapi-部署>kkapi 部署</a></li><li><a href=#kkapiadmin可视化管理后台>kkapiadmin（可视化管理后台）</a></li></ul></li><li><a href=#前端部署>前端部署</a></li><li><a href=#github-登陆验证可选>Github 登陆验证（可选*）</a></li><li><a href=#完工>完工</a></li></ul></nav></div></div><div class=content id=content><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fwwarning"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>本文最后更新于 <span class=timeago datetime=2022-10-16T00:00:00 title="October 16, 2022">2022-10-16</span>，文中内容可能已过时。</div></div></div><h2 id=前言 class=headerLink><a href=#%e5%89%8d%e8%a8%80 class=header-mark></a>前言</h2><p>感觉原来的 Artitalk 说说不好康，在开往里发现好多博客都用的说说功能叫叨叨点啥，看了看作者的<a href=https://www.antmoe.com/speak/ target=_blank rel="noopener noreferrer">说说页面</a>，可以插入图片和标签分类，还有仅自己可见的功能，感觉挺不错的（实际是自己想折腾）所以就整一个。自己在部署过程中实在是踩了不少的坑，而且作者的文档感觉写的也不算完善，所以打算自己记录一下。</p><h2 id=项目结构 class=headerLink><a href=#%e9%a1%b9%e7%9b%ae%e7%bb%93%e6%9e%84 class=header-mark></a>项目结构</h2><p>作者的文档中各种仓库链接属实给我跳晕了，最后理出来的项目分为以下部分：</p><ul><li><code>kkapi</code>。是作为说说的后端部分，连接 MongoDB 数据库，还有一个<code>kkadmin</code>的管理页面</li><li><code>ISpeak</code>。说说的主体部分，依赖于后端的 <code>kkapi</code> ，分为前端的展示页面，和一个对接后端的发布说说页面。</li></ul><p>作者文档中给出很多部署方法，白嫖版的就是 vercel 后端 api + 管理界面 + MongoDB 提供的云服务，但是个人感觉 vercel 经常被墙，所以部署的 api 感觉也不会稳定，而且考虑到数据的存放问题，所以我选择的是都部署到自己服务器上。</p><h2 id=后端部署 class=headerLink><a href=#%e5%90%8e%e7%ab%af%e9%83%a8%e7%bd%b2 class=header-mark></a>后端部署</h2><h3 id=docker-安装-mongodb class=headerLink><a href=#docker-%e5%ae%89%e8%a3%85-mongodb class=header-mark></a>Docker 安装 Mongodb</h3><p>安装可以参考菜鸟教程的 <a href=https://www.runoob.com/docker/docker-install-mongodb.html target=_blank rel="noopener noreferrer">Docker 安装 MongoDB</a> 。因为之前听过 MongoDB 的未授权访问，所以考虑到安全性问题，创建容器的时候添加 <code>MONGO_INITDB_ROOT_USERNAME</code> 和 <code>MONGO_INITDB_ROOT_PASSWORD</code> 设置用户的账号密码，开启Docker MongoDB 的身份验证。考虑到数据未来的迁移可以通过 <code>-v</code> 挂载宿主机的一个目录。可以修改默认端口再减少一些风险。最后我启动的命令如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>docker run -d --name mongodb <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-p xxxxx:27017 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-v /my/own/datadir:/data/db <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-e <span class=nv>MONGO_INITDB_ROOT_USERNAME</span><span class=o>=</span>mongoadmin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-e <span class=nv>MONGO_INITDB_ROOT_PASSWORD</span><span class=o>=</span>secret <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--restart<span class=o>=</span>always
</span></span><span class=line><span class=cl>	mongo
</span></span></code></pre></td></tr></table></div></div><p>之后可以使用工具测试一下连接。</p><h3 id=kkapi-部署 class=headerLink><a href=#kkapi-%e9%83%a8%e7%bd%b2 class=header-mark></a>kkapi 部署</h3><p>和项目文档中的教程差不多，要注意使用的 node 版本请高于 <code>16.0.0</code></p><ol><li>首先克隆项目源码
<code>git clone https://ghproxy.com/https://github.com/kkfive/kkapi-open.git</code></li><li>接下来项目需要安装的工具 <code>yarn</code> 和 <code>pm2</code>，分别是
<code>npm i yarn -g</code>
<code>npm i pm2 -g</code></li><li>然后安装项目所需依赖 <code>yarn install</code> 。</li><li>之后再执行 <code>yarn build</code> 编译项目。这里我的小鸡顶不住编译所以自己在本地编译传上去了💧。</li><li>在项目文件夹创建环境变量文件，格式如</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_URL</span><span class=o>=</span>mongodb://127.0.0.1:27017/kkpaiopen?authSource<span class=o>=</span>admin
</span></span><span class=line><span class=cl><span class=nv>DATABASE_USER</span><span class=o>=</span>mongoadmin
</span></span><span class=line><span class=cl><span class=nv>DATABASE_PASSWORD</span><span class=o>=</span>secret
</span></span><span class=line><span class=cl><span class=c1># 加密密钥 测试</span>
</span></span><span class=line><span class=cl><span class=nv>SECRETKEY</span><span class=o>=</span>xxxxxxxxxxxxxxx
</span></span></code></pre></td></tr></table></div></div><p>这里的数据库连接地址我原来还想使用MongoDB提供的免费云服务当数据库，但是没搞成功，所以最后使用了本地的 MongoDB，有大佬知道的可以指点一下。</p><ol start=6><li>使用 <code>pm2</code> 使用守护线程启动项目
<code>pm2 start pm2.json</code></li></ol><p>我启动项目遇到了 <code>[PM2][WARN] Expect “restart_delay” to be a typeof [object Number], but now is [object String]</code> 错误，这个错误原因是作者的 pm2.json 中的 <code>restart_delay</code> 值是字符串类型 <code>60s</code> 改成数值 <code>60</code> 就可以了。</p><ol start=7><li><p>测试项目是否成功启动
可以使用 <code>lsof -i:端口</code> 查看端口是否被监听判断项目是否成功启动。没成功的原因大概率是因为数据库连接地址、数据库账号密码不正确。</p></li><li><p>创建初始化用户
<code>curl http://127.0.0.1:3000/api/user/init</code>
创建的默认用户名和密码是 <code>admin</code> 和 <code>123456</code>，这个用户名密码用来登陆可视化的管理后台，并且用户似乎<strong>只能拥有一个</strong>。</p></li></ol><h3 id=kkapiadmin可视化管理后台 class=headerLink><a href=#kkapiadmin%e5%8f%af%e8%a7%86%e5%8c%96%e7%ae%a1%e7%90%86%e5%90%8e%e5%8f%b0 class=header-mark></a>kkapiadmin（可视化管理后台）</h3><p>参考<a href=https://kkapi.js.org/guide/admin/setup.html target=_blank rel="noopener noreferrer">官方文档</a>中的教程，使用的 Vercel 部署的。这个墙不墙的就无所谓了，注意的坑有：</p><ul><li>修改部署分支和生产分支为 <code>vercel</code>。</li><li>fork 作者仓库的时候记得把 only fork master 取消勾选。</li></ul><p>之后登录就是用前面初始化的用户名密码，进入后台以后可以修改密码。登陆后台以后需要设置：</p><ul><li>ISpeak 标签。因为发布说说是需要选择标签的，标签中的背景颜色值是<strong>十六进制的颜色</strong>代码</li><li>添加用户token。<strong>需要注意！！！</strong>，添加的token的<strong>标题</strong>只能是 <code>speak</code> 不能是其他的，否则发布说说时会提示token不存在，发布时验证的就是字段为 <code>speak</code> 的token的值。</li></ul><p><figure><a class=lightgallery href=https://img.braindance.top/artical/2022/10/04/c5191febc049fbed86f5b77df8367c89.png title=https://img.braindance.top/artical/2022/10/04/c5191febc049fbed86f5b77df8367c89.png data-thumbnail=https://img.braindance.top/artical/2022/10/04/c5191febc049fbed86f5b77df8367c89.png><img loading=lazy src=https://img.braindance.top/artical/2022/10/04/c5191febc049fbed86f5b77df8367c89.png srcset="https://img.braindance.top/artical/2022/10/04/c5191febc049fbed86f5b77df8367c89.png, https://img.braindance.top/artical/2022/10/04/c5191febc049fbed86f5b77df8367c89.png 1.5x, https://img.braindance.top/artical/2022/10/04/c5191febc049fbed86f5b77df8367c89.png 2x" sizes=auto alt=https://img.braindance.top/artical/2022/10/04/c5191febc049fbed86f5b77df8367c89.png></a></figure></p><p>接下来可以在前端说说页面测试发布说说，发布说说需要输入后端 kkapi 地址、用户id （在管理后台可以找到）、token。网址：https://ispeak-biubiu.vercel.app/</p><p><figure><a class=lightgallery href=https://img.braindance.top/artical/2022/10/04/778dcc5fe051722e4f9a919b7a9e2a61.png title=https://img.braindance.top/artical/2022/10/04/778dcc5fe051722e4f9a919b7a9e2a61.png data-thumbnail=https://img.braindance.top/artical/2022/10/04/778dcc5fe051722e4f9a919b7a9e2a61.png><img loading=lazy src=https://img.braindance.top/artical/2022/10/04/778dcc5fe051722e4f9a919b7a9e2a61.png srcset="https://img.braindance.top/artical/2022/10/04/778dcc5fe051722e4f9a919b7a9e2a61.png, https://img.braindance.top/artical/2022/10/04/778dcc5fe051722e4f9a919b7a9e2a61.png 1.5x, https://img.braindance.top/artical/2022/10/04/778dcc5fe051722e4f9a919b7a9e2a61.png 2x" sizes=auto alt=https://img.braindance.top/artical/2022/10/04/778dcc5fe051722e4f9a919b7a9e2a61.png></a></figure></p><p><figure><a class=lightgallery href=https://img.braindance.top/artical/2022/10/04/491fff2969d731ff17d8799fe6a20d14.png title=https://img.braindance.top/artical/2022/10/04/491fff2969d731ff17d8799fe6a20d14.png data-thumbnail=https://img.braindance.top/artical/2022/10/04/491fff2969d731ff17d8799fe6a20d14.png><img loading=lazy src=https://img.braindance.top/artical/2022/10/04/491fff2969d731ff17d8799fe6a20d14.png srcset="https://img.braindance.top/artical/2022/10/04/491fff2969d731ff17d8799fe6a20d14.png, https://img.braindance.top/artical/2022/10/04/491fff2969d731ff17d8799fe6a20d14.png 1.5x, https://img.braindance.top/artical/2022/10/04/491fff2969d731ff17d8799fe6a20d14.png 2x" sizes=auto alt=https://img.braindance.top/artical/2022/10/04/491fff2969d731ff17d8799fe6a20d14.png></a></figure></p><p>发布成功可以在后端看到发布的说说。</p><h2 id=前端部署 class=headerLink><a href=#%e5%89%8d%e7%ab%af%e9%83%a8%e7%bd%b2 class=header-mark></a>前端部署</h2><p>我使用的是 Ispeak 搭配的 twikoo 评论，因为现在博客使用的就是 twikoo，省去了再部署评论的麻烦。根据<a href=https://kkapi.js.org/posts/ispeak/ target=_blank rel="noopener noreferrer">ISpeak文档部分</a>，<a href=https://github.com/kkfive/ISpeak/blob/master/src/types/parameter.ts target=_blank rel="noopener noreferrer">ispeak 配置项</a>中 <code>comment</code> 是一个回调函数，可以自行初始化评论，参照twikoo评论初始化的格式。我博客中的说说页面代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;tip&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;text-align:center;&#34;</span><span class=p>&gt;</span>ipseak加载中<span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;ispeak&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>link</span>
</span></span><span class=line><span class=cl>  <span class=na>rel</span><span class=o>=</span><span class=s>&#34;stylesheet&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>href</span><span class=o>=</span><span class=s>&#34;https://cdn.staticfile.org/highlight.js/10.6.0/styles/atom-one-dark.min.css&#34;</span>
</span></span><span class=line><span class=cl><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>link</span>
</span></span><span class=line><span class=cl>  <span class=na>rel</span><span class=o>=</span><span class=s>&#34;stylesheet&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>href</span><span class=o>=</span><span class=s>&#34;https://cdn.jsdelivr.net/npm/ispeak@4.4.0/style.css&#34;</span>
</span></span><span class=line><span class=cl><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.staticfile.org/highlight.js/10.6.0/highlight.min.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.staticfile.org/marked/2.0.0/marked.min.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.jsdelivr.net/npm/ispeak@4.4.0/ispeak.umd.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>head</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementsByTagName</span><span class=p>(</span><span class=s1>&#39;head&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>meta</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;meta&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>meta</span><span class=p>.</span><span class=nx>name</span> <span class=o>=</span> <span class=s1>&#39;referrer&#39;</span>
</span></span><span class=line><span class=cl>  <span class=nx>meta</span><span class=p>.</span><span class=nx>content</span> <span class=o>=</span> <span class=s1>&#39;no-referrer&#39;</span>
</span></span><span class=line><span class=cl>  <span class=nx>head</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>meta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>ispeak</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ispeak</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>el</span><span class=o>:</span> <span class=s1>&#39;#ispeak&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>api</span><span class=o>:</span> <span class=s1>&#39;这里是后端kkapi地址&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>author</span><span class=o>:</span> <span class=s1>&#39;后端用户id&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>pageSize</span><span class=o>:</span> <span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>loading_img</span><span class=o>:</span> <span class=s1>&#39;https://bu.dusays.com/2021/03/04/d2d5e983e2961.gif&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>comment</span><span class=o>:</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>speak</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=p>{</span> <span class=nx>_id</span><span class=p>,</span> <span class=nx>title</span><span class=p>,</span> <span class=nx>content</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>speak</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 4.4.0 之后在此回调函数中初始化评论
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=c1>//这里是twikoo的初始化配置，如果使用其他评论可以在这里修改
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>twikoo</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span> 
</span></span><span class=line><span class=cl>            <span class=nx>el</span><span class=o>:</span> <span class=s1>&#39;.ispeak-comment&#39;</span><span class=p>,</span> <span class=c1>// 默认情况下 ipseak 生成class为 ispeak-comment 的div
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/shuoshuo/?q=&#39;</span> <span class=o>+</span> <span class=nx>_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>envId</span><span class=o>:</span> <span class=s2>&#34;twikoo后端地址&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;ispeak 加载完成&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;tip&#39;</span><span class=p>).</span><span class=nx>style</span><span class=p>.</span><span class=nx>display</span> <span class=o>=</span> <span class=s1>&#39;none&#39;</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;tip&#39;</span><span class=p>).</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=s1>&#39;ipseak依赖加载失败！&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>更新一波。被人发现了说说的评论没有独立，自己改了下配置。
上面的代码加入了 32 和 37 行代码，其中 37 行 <code>path</code> 属性设置为你当前的说说页面路径加 <code>q</code> 参数，这个参数可能无所谓吧，但是 <code>_id</code> 是当前说说的唯一 id，因为自己在页面中测试时，说说评论请求的地址格式也是根据 37 行代码这个进行请求查询的。</p><h2 id=github-登陆验证可选 class=headerLink><a href=#github-%e7%99%bb%e9%99%86%e9%aa%8c%e8%af%81%e5%8f%af%e9%80%89 class=header-mark></a>Github 登陆验证（可选*）</h2><p>可以发布仅登陆可见的说说，但是需要配置 Github app。</p><ol><li>参考<a href=https://kkapi.js.org/guide/setup/github.html target=_blank rel="noopener noreferrer">项目文档</a>创建 app ，其中填写的 speak 页面路径就是 ISpeak 所在的博客路径</li><li>创建以后拥有了 <code>Client ID</code> 和 <code>Client Secrets</code>，这两项需要填写在 kkapi 后端部署的 <code>local.env</code> 配置中。</li><li>在 kkapi 的后端界面个人设置中填写 <code>GitHubId</code> 。获得方法访问 github 提供的接口
<code>https://api.github.com/users/&lt;Your UserName></code>注意替换尖括号整体为你github的用户名，不是昵称。</li></ol><p><figure><a class=lightgallery href=https://file.acs.pw/picGo/2022/03/13/20220313121930.png title=https://file.acs.pw/picGo/2022/03/13/20220313121930.png data-thumbnail=https://file.acs.pw/picGo/2022/03/13/20220313121930.png><img loading=lazy src=https://file.acs.pw/picGo/2022/03/13/20220313121930.png srcset="https://file.acs.pw/picGo/2022/03/13/20220313121930.png, https://file.acs.pw/picGo/2022/03/13/20220313121930.png 1.5x, https://file.acs.pw/picGo/2022/03/13/20220313121930.png 2x" sizes=auto alt=https://file.acs.pw/picGo/2022/03/13/20220313121930.png></a></figure></p><ol start=4><li>在前端页面的 <code>speak</code> 初始化中添加两个属性</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>ispeak</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=nx>speakPage</span><span class=err>：</span><span class=s2>&#34;/shuoshuo/&#34;</span><span class=p>,</span>  <span class=c1>//这里是说说的页面路径，对应于 github app 中填写的 speak 页面路径（用双引号括起来，我不知道为啥单引号不行）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>githubClientId</span><span class=o>:</span> <span class=s1>&#39;Iv1.*******&#39;</span><span class=p>,</span>  <span class=c1>//github app 的 Client ID
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>然后就可以在你的说说下面找到一个 Github 授权登陆。</p><p><figure><a class=lightgallery href=https://img.braindance.top/artical/2022/10/04/4aeea0532e5dc44c83a6822033d9971e.png title=https://img.braindance.top/artical/2022/10/04/4aeea0532e5dc44c83a6822033d9971e.png data-thumbnail=https://img.braindance.top/artical/2022/10/04/4aeea0532e5dc44c83a6822033d9971e.png><img loading=lazy src=https://img.braindance.top/artical/2022/10/04/4aeea0532e5dc44c83a6822033d9971e.png srcset="https://img.braindance.top/artical/2022/10/04/4aeea0532e5dc44c83a6822033d9971e.png, https://img.braindance.top/artical/2022/10/04/4aeea0532e5dc44c83a6822033d9971e.png 1.5x, https://img.braindance.top/artical/2022/10/04/4aeea0532e5dc44c83a6822033d9971e.png 2x" sizes=auto alt=https://img.braindance.top/artical/2022/10/04/4aeea0532e5dc44c83a6822033d9971e.png></a></figure></p><h2 id=完工 class=headerLink><a href=#%e5%ae%8c%e5%b7%a5 class=header-mark></a>完工</h2><p>说说还支持 markdown 格式的图片插入，看起来更好用了，给作者点个赞。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-10-16</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E8%AF%B4%E8%AF%B4/>说说</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/%E8%BF%91%E6%9C%9F%E6%80%BB%E7%BB%93/ class=prev rel=prev title=近期总结><i class="fas fa-angle-left fa-fw"></i>近期总结</a>
<a href=/posts/zut-%E4%BD%BF%E7%94%A8%E8%B7%AF%E7%94%B1%E5%99%A8%E8%BF%9E%E6%8E%A5%E6%A0%A1%E5%9B%AD%E7%BD%91/ class=next rel=next title="ZUT 使用路由器连接校园网">ZUT 使用路由器连接校园网<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=twikoo></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://twikoo.js.org/>Twikoo</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.111.3">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.3.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer">Braindance</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{twikoo:{commentCount:!0,el:"#twikoo",envId:"https://twikoo.penginman.com/",lang:"zh-cn"}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1},table:{sort:!0},twemoji:!0}</script><script type=text/javascript src=/lib/twikoo/twikoo.all.min.js defer></script><script type=text/javascript src=/js/twikoo.min.js defer></script><script type=text/javascript src=/lib/tablesort/tablesort.min.js></script><script type=text/javascript src=/lib/twemoji/twemoji.min.js defer></script><script type=text/javascript src=/js/twemoji.min.js defer></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-176925141-1",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-176925141-1" async></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?3b1ab845351bb3a8ee808b639bca6ce5",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></div></body></html>